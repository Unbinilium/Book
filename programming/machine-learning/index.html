<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Machine Learning | Unbinilium&#39;s ðŸ“–</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="manifest" href="/manifest.json" crossorigin="use-credentials">
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <meta name="description" content="Unbinilium's personal knowledge book">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="msapplication-TileColor" content="#fff">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon.png">
    <meta property="og:title" content="Unbinilium's ðŸ“–">
    <meta property="og:description" content="Unbinilium's personal knowledge book">
    <meta property="og:url" content="https://xn--vt8h.unbinilium.me/">
    <meta property="og:image" content="https://xn--vt8h.unbinilium.me/open_graph_logo.png">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Unbinilium's ðŸ“–">
    
    <link rel="preload" href="/assets/css/0.styles.c86a7820.css" as="style"><link rel="preload" href="/assets/js/app.041ccf91.js" as="script"><link rel="preload" href="/assets/js/2.30d40f56.js" as="script"><link rel="preload" href="/assets/js/24.63f564f1.js" as="script"><link rel="preload" href="/assets/js/3.9032db0e.js" as="script"><link rel="prefetch" href="/assets/js/10.469d6b72.js"><link rel="prefetch" href="/assets/js/11.c6524284.js"><link rel="prefetch" href="/assets/js/12.ce88ebf9.js"><link rel="prefetch" href="/assets/js/13.ab2b84d3.js"><link rel="prefetch" href="/assets/js/14.fe038601.js"><link rel="prefetch" href="/assets/js/15.a0555c26.js"><link rel="prefetch" href="/assets/js/16.f55579dd.js"><link rel="prefetch" href="/assets/js/17.ebad19b1.js"><link rel="prefetch" href="/assets/js/18.fadf84da.js"><link rel="prefetch" href="/assets/js/19.43a71af3.js"><link rel="prefetch" href="/assets/js/20.946ff141.js"><link rel="prefetch" href="/assets/js/21.811b4ca6.js"><link rel="prefetch" href="/assets/js/22.4d4a6949.js"><link rel="prefetch" href="/assets/js/23.db0b25e6.js"><link rel="prefetch" href="/assets/js/25.ef3461c4.js"><link rel="prefetch" href="/assets/js/26.6354f890.js"><link rel="prefetch" href="/assets/js/27.1b44817a.js"><link rel="prefetch" href="/assets/js/28.30ebeba7.js"><link rel="prefetch" href="/assets/js/29.fd0c526c.js"><link rel="prefetch" href="/assets/js/30.3294a55b.js"><link rel="prefetch" href="/assets/js/4.5e92b263.js"><link rel="prefetch" href="/assets/js/5.665901b5.js"><link rel="prefetch" href="/assets/js/6.6ba3b61b.js"><link rel="prefetch" href="/assets/js/7.d31a3cd7.js"><link rel="prefetch" href="/assets/js/8.d4661bf2.js"><link rel="prefetch" href="/assets/js/9.168171d4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c86a7820.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Unbinilium's ðŸ“–</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link router-link-active">
  Book
</a></div><div class="nav-item"><a href="https://unbinilium.me/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link router-link-active">
  Book
</a></div><div class="nav-item"><a href="https://unbinilium.me/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Coding</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Programming</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/programming/algorithm/" class="sidebar-link">Algorithm</a></li><li><a href="/programming/computer-vision/" class="sidebar-link">Computer Vision</a></li><li><a href="/programming/machine-learning/" aria-current="page" class="active sidebar-link">Machine Learning</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/programming/machine-learning/#deepfont" class="sidebar-link">DeepFont</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/programming/machine-learning/#datasets" class="sidebar-link">Datasets</a></li><li class="sidebar-sub-header"><a href="/programming/machine-learning/#preprocessing" class="sidebar-link">Preprocessing</a></li><li class="sidebar-sub-header"><a href="/programming/machine-learning/#architecture" class="sidebar-link">Architecture</a></li><li class="sidebar-sub-header"><a href="/programming/machine-learning/#evaluate" class="sidebar-link">Evaluate</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Security</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Software</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Design</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Writing</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Collection</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>See Also</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><strong>Machine learning</strong> (<strong>ML</strong>) is the study of computer algorithms that improve automatically through experience. Here I wrote some notes about Tensorflow, PyTorch, Keras and some mainstream machine learning frameworks.</p> <h2 id="deepfont"><a href="#deepfont" class="header-anchor">#</a> DeepFont</h2> <p>It was first introduced by Adobe, which uses deep learning to identify font type. Inspired by their works, I made this reproduction using <a href="https://keras.io" target="_blank" rel="noopener noreferrer">Keras<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://arxiv.org/pdf/1507.03196v1.pdf" target="_blank" rel="noopener noreferrer">DeepFont: Identify Your Font from An Image<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>Their technical contributions are listed below:</p> <ul><li><p><strong>AdobeVFR Dataset</strong> A large set of labeled real-world images as well as a large corpus of unlabeled real-world data are collected for both training and testing, which could be found at the link below.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://github.com/tensorflow/datasets/issues/431" target="_blank" rel="noopener noreferrer"> Adobe Visual Font Recognition (VFR)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></li> <li><p><strong>Domain Adapted CNN</strong> This real-to-synthetic domain gap caused poor generalization to new real data in previous VFR methods. They address this domain mismatch problem by leveraging synthetic data to obtain effective classification features, while introducing a domain adaptation technique based on Stacked Convolutional Auto Encoder (SCAE) with the help of unlabeled real-world data.</p></li> <li><p><strong>Learning-based Model Compression</strong> They introduce a novel learning-based approach to obtain a losslessly compressible model, for a high compression ratio with- out sacrificing its performance. An exact low-rank constraint is enforced on the targeted weight matrix.</p></li></ul> <h3 id="datasets"><a href="#datasets" class="header-anchor">#</a> Datasets</h3> <p>To apply machine learning to VFR problem, both synthetic and realistic text images with ground truth font labels is required. The way to overcome the training data challenge is to synthesize the training set by rendering text fragments for all the necessary fonts.</p> <h4 id="synthetic-text"><a href="#synthetic-text" class="header-anchor">#</a> Synthetic Text</h4> <p>It's easy to generate dataset based custom font image patches using <strong>TextRecognitionDataGenerator</strong>.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://github.com/Belval/TextRecognitionDataGenerator" target="_blank" rel="noopener noreferrer">GitHub - TextRecognitionDataGenerator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>Words will be randomly chosen from a dictionary of a specific language. Then an image of those words will be generated by using font, background, and modifications (skewing, blurring, etc.) as specified.</p> <p>TextRecognitionDataGenerator comes with an easy to use CLI and Python Module. It has a nice written tutorial.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://textrecognitiondatagenerator.readthedocs.io/en/latest/tutorial.html#" target="_blank" rel="noopener noreferrer">TextRecognitionDataGenerator Tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h4 id="realistic-text"><a href="#realistic-text" class="header-anchor">#</a> Realistic Text</h4> <p><strong>AdobeVFR Dataset</strong> obtain 4,384 real-world test images with reliable labels, covering 617 classes (out of 2,383). Compared to the synthetic data, these images typically have much larger appearance variations caused by scaling, back- ground clutter, lighting, noise, perspective distortions, and compression artifacts.</p> <h3 id="preprocessing"><a href="#preprocessing" class="header-anchor">#</a> Preprocessing</h3> <p>Fonts are different with objects, which have huge spatial information when classify features. Aimed to reduce the mismatch, preprocessing is required and exampled by the paper.</p> <p>Firstly, import needed modules.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> PIL
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Add <code>%matplotlib inline</code> as Magic Function if uses IPython to render images directly in browser. Otherwise, It would cause errors if you're not using IPython.</p></div> <p>Then code image load function.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">pil_image</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pil_img <span class="token operator">=</span> PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span>
    pil_img <span class="token operator">=</span> pil_img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pil_img
</code></pre></div><h4 id="legacy"><a href="#legacy" class="header-anchor">#</a> Legacy</h4> <p>It is usual to artificially augment training data using label-preserving transformations to reduce overfitting.</p> <ul><li><p><strong>Noise</strong> a small Gaussian noise with 0 mean and standard deviation 3 is added to input.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">noise_image</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    img_array <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    mean <span class="token operator">=</span> <span class="token number">0.0</span>
    std <span class="token operator">=</span> <span class="token number">3</span>
    noisy_img <span class="token operator">=</span> img_array <span class="token operator">+</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>normal<span class="token punctuation">(</span>mean<span class="token punctuation">,</span> std<span class="token punctuation">,</span> img_array<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    noisy_img_clipped <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>noisy_img<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>
    noise_img <span class="token operator">=</span> PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">(</span>noisy_img_clipped<span class="token punctuation">)</span><span class="token punctuation">)</span>
    noise_img <span class="token operator">=</span> noise_img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> noise_img
</code></pre></div></li> <li><p><strong>Blur</strong> a random Gaussian blur with standard deviation from 2.5 to 3.5 is added to input.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">blur_image</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    blur_img <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>PIL<span class="token punctuation">.</span>ImageFilter<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>radius <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    blur_img <span class="token operator">=</span> blur_img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> blur_img
</code></pre></div></li> <li><p><strong>Perspective Rotation</strong> a randomly-parameterized affine transformation is added to input.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">affine_rotation</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rows<span class="token punctuation">,</span> columns <span class="token operator">=</span> img<span class="token punctuation">.</span>shape

    point1 <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    point2 <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    anchor <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getAffineTransform<span class="token punctuation">(</span>point1<span class="token punctuation">,</span> point2<span class="token punctuation">)</span>

    output <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>img<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> <span class="token punctuation">(</span>columns<span class="token punctuation">,</span> rows<span class="token punctuation">)</span><span class="token punctuation">)</span>
    affine_img <span class="token operator">=</span> PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
    affine_img <span class="token operator">=</span> affine_img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> affine_img
</code></pre></div></li> <li><p><strong>Shading</strong> the input background is filled with a gradient in illumination.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">gradient_fill</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output <span class="token operator">=</span> cv2<span class="token punctuation">.</span>Laplacian<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>CV_64F<span class="token punctuation">)</span>
    laplacian_img <span class="token operator">=</span> PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
    laplacian_img <span class="token operator">=</span> laplacian_img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> laplacian_img
</code></pre></div></li></ul> <h4 id="additional"><a href="#additional" class="header-anchor">#</a> Additional</h4> <p>As a very particular type of images, text images have various real-world appearances caused by specific handlings. Based on the observations in the paper, they identify two additional font-specific augmentation steps to the training data.</p> <ul><li><strong>Variable Character Spacing</strong> when rendering each synthetic image, set the character spacing (by pixel) to be a Gaussian random variable of mean 10 and standard deviation 40, bounded by [0, 50].</li> <li><strong>Variable Aspect Ratio</strong> Before cropping each image into a input patch, the image, with heigh fixed, is squeezed in width by a random ratio, drawn from a uniform distribution between <mjx-container jax="CHTML" class="MathJax"><mjx-math class=" MJX-TEX"><mjx-mfrac><mjx-frac><mjx-num><mjx-nstrut></mjx-nstrut><mjx-mn size="s" class="mjx-n"><mjx-c c="5"></mjx-c></mjx-mn></mjx-num><mjx-dbox><mjx-dtable><mjx-line></mjx-line><mjx-row><mjx-den><mjx-dstrut></mjx-dstrut><mjx-mn size="s" class="mjx-n"><mjx-c c="6"></mjx-c></mjx-mn></mjx-den></mjx-row></mjx-dtable></mjx-dbox></mjx-frac></mjx-mfrac></mjx-math></mjx-container> and <mjx-container jax="CHTML" class="MathJax"><mjx-math class=" MJX-TEX"><mjx-mfrac><mjx-frac><mjx-num><mjx-nstrut></mjx-nstrut><mjx-mn size="s" class="mjx-n"><mjx-c c="7"></mjx-c></mjx-mn></mjx-num><mjx-dbox><mjx-dtable><mjx-line></mjx-line><mjx-row><mjx-den><mjx-dstrut></mjx-dstrut><mjx-mn size="s" class="mjx-n"><mjx-c c="6"></mjx-c></mjx-mn></mjx-den></mjx-row></mjx-dtable></mjx-dbox></mjx-frac></mjx-mfrac></mjx-math></mjx-container>.</li></ul> <p>It not convenient to do the additional steps for each characters, so loosely speaking, we could done this before legacy steps, at the beginning we generate our datasets using <em>TextRecognitionDataGenerator</em>.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>python3 run.py -c <span class="token number">10</span> -k <span class="token number">15</span> -rk -d <span class="token number">3</span> -do <span class="token number">2</span> -f <span class="token number">64</span> -ft <span class="token punctuation">[</span><span class="token string">'Font1'</span>, <span class="token string">'Font2'</span>, <span class="token string">'Font3'</span><span class="token punctuation">]</span> -t <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> -c ^processor /proc/cpuinfo<span class="token variable">)</span></span>
</code></pre></div><p>This generate 10 examples with <em>Font1</em>, <em>Font2</em> and <em>Font3</em> which characters sized 64x64 with a skewing angle between -15 and 15 and a random distorsions both vertical and horizontal, multi-threads acceleration enabled.</p> <p>Otherwise, it would be more difficult if we do as same as the paper. Firstly we generate single characters in same font with random aspect ratio follow the paper advice, the we flatten all these single characters with random spacing into many word, again we got a sentence in one image labeled by the font. Lastly by repeating these steps, we got images datasets with different fonts before applying legacy steps.</p> <p>However, weâ€™re supposed to do something which is similar to this at the end of datasets importing and actually I did it this way. To be clear why we could  and should do this, I would clear that thereâ€™re something that I misunderstood and it totally different, just imaging the real situation when people tring to identify a font, the font would always be some part of some texts which has strong and clear characteristic, Itâ€™s the most important connection to our datasets, but the preprocessing solution I suggested before, just using the opponent side to undermine the most print fontâ€™s characteristic, through it may did some help on handwriting font recognition.</p> <h3 id="architecture"><a href="#architecture" class="header-anchor">#</a> Architecture</h3> <p>Domain adapted CNN employs a Convolutional Neural Network (CNN) architecture, which is further decomposed into two sub-networks:</p> <ul><li><strong>A &quot;shared&quot; low-level sub-network</strong> which is learned from the composite set of synthetic and real-world data.</li> <li><strong>A high-level sub-network</strong> that learns a deep classifier from the low-level features.</li></ul> <h4 id="generate-datasets"><a href="#generate-datasets" class="header-anchor">#</a> Generate Datasets</h4> <p>Here we use the <em>Text Recognition Data Generator</em> CLI <code>trdg</code> to generate the random datasets.</p> <ul><li><p><code>ttf_path</code> is a folder contains all the font file with correct font name and <code>.ttf</code> extension.</p></li> <li><p><code>data_path</code> is a folder stores or contains generated datasets.</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> os

ttf_path <span class="token operator">=</span> <span class="token string">'ttf_path'</span>
data_path <span class="token operator">=</span> <span class="token string">'datasets_path'</span>

<span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>ttf_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.ttf'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>ttf_path<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span>
        name<span class="token punctuation">,</span> ext <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
        out_path <span class="token operator">=</span> data_path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> name
        command <span class="token operator">=</span> <span class="token string">'trdg -l en -c 10 -rs -let -num -r --length 1 -b 1 -e .png -fi -f 105 -ft '</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">' --output_dir '</span> <span class="token operator">+</span> out_path 
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>command<span class="token punctuation">)</span>
</code></pre></div><h4 id="import-datasets"><a href="#import-datasets" class="header-anchor">#</a> Import Datasets</h4> <p>Import pre-generated synthetic and realistic text images from <code>datasets_path</code> <em>(here especially the datasets we generated before)</em>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">from</span> imutils <span class="token keyword">import</span> paths
<span class="token keyword">from</span> random <span class="token keyword">import</span> seed<span class="token punctuation">,</span> shuffle

image_paths <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>paths<span class="token punctuation">.</span>list_images<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>image_paths<span class="token punctuation">)</span>

font_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> f<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        font_names<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        
font_names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Font Names -&gt; '</span><span class="token punctuation">,</span> font_names<span class="token punctuation">)</span>
</code></pre></div><h4 id="tag-labels"><a href="#tag-labels" class="header-anchor">#</a> Tag Labels</h4> <p>Convert font name string to integer and use the matched number as a font label when training models.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">conv_label</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> font_names<span class="token punctuation">.</span>index<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
</code></pre></div><h4 id="preprocessing-datasets"><a href="#preprocessing-datasets" class="header-anchor">#</a> Preprocessing Datasets</h4> <p>Preprocessing functions are already finished, for each font patch images, effects should be applied randomly, so firstly we generate random combinations in 4 legacy preprocessing functions. Then apply the effects following the generated combinations list for all the font patch images.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image <span class="token keyword">import</span> img_to_array

data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
auguments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;blur&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;noise&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;affine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;gradient&quot;</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> path <span class="token keyword">in</span> image_paths<span class="token punctuation">:</span>
    label <span class="token operator">=</span> path<span class="token punctuation">.</span>split<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
    
    <span class="token keyword">if</span> <span class="token keyword">not</span> label<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        label <span class="token operator">=</span> conv_label<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    
    pil_img <span class="token operator">=</span> pil_image<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    org_img <span class="token operator">=</span> img_to_array<span class="token punctuation">(</span>pil_img<span class="token punctuation">)</span>
    
    data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>org_img<span class="token punctuation">)</span>
    labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>auguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> augument <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>itertools<span class="token punctuation">.</span>combinations<span class="token punctuation">(</span>auguments<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            
            temp_img <span class="token operator">=</span> pil_img
            combinations <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>augument<span class="token punctuation">)</span>
            
            <span class="token keyword">for</span> method <span class="token keyword">in</span> combinations<span class="token punctuation">:</span>
                <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">'noise'</span><span class="token punctuation">:</span>
                    temp_img <span class="token operator">=</span> noise_image<span class="token punctuation">(</span>temp_img<span class="token punctuation">)</span>
                    
                <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">'blur'</span><span class="token punctuation">:</span>
                    temp_img <span class="token operator">=</span> blur_image<span class="token punctuation">(</span>temp_img<span class="token punctuation">)</span>
                    
                <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">'affine'</span><span class="token punctuation">:</span>
                    open_cv_affine <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>pil_img<span class="token punctuation">)</span>
                    temp_img <span class="token operator">=</span> affine_rotation<span class="token punctuation">(</span>open_cv_affine<span class="token punctuation">)</span>

                <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">'gradient'</span><span class="token punctuation">:</span>
                    open_cv_gradient <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>pil_img<span class="token punctuation">)</span>
                    temp_img <span class="token operator">=</span> gradient_fill<span class="token punctuation">(</span>open_cv_gradient<span class="token punctuation">)</span>
  
            temp_img <span class="token operator">=</span> img_to_array<span class="token punctuation">(</span>temp_img<span class="token punctuation">)</span>
    
            data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_img<span class="token punctuation">)</span>
            labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
</code></pre></div><p>According to the paper, 75% of the datasets is for training and the remaining 25% is for testing, so partition the data into training and testing is required.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split

data <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>data<span class="token punctuation">,</span> dtype <span class="token operator">=</span> <span class="token string">&quot;float&quot;</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.0</span>
labels <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>

<span class="token punctuation">(</span>trainX<span class="token punctuation">,</span> testX<span class="token punctuation">,</span> trainY<span class="token punctuation">,</span> testY<span class="token punctuation">)</span> <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>data<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> test_size <span class="token operator">=</span> <span class="token number">0.25</span><span class="token punctuation">,</span> random_state <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div><p>For further processing, both train and test labels of the datasets should be converted from integers to vectors.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> keras<span class="token punctuation">.</span>utils <span class="token keyword">import</span> to_categorical

trainY <span class="token operator">=</span> to_categorical<span class="token punctuation">(</span>trainY<span class="token punctuation">,</span> num_classes <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>font_names<span class="token punctuation">)</span><span class="token punctuation">)</span>
testY <span class="token operator">=</span> to_categorical<span class="token punctuation">(</span>testY<span class="token punctuation">,</span> num_classes <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>font_names<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Then process the  datasets using additional preprocessing steps.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image <span class="token keyword">import</span> ImageDataGenerator

augmented_images <span class="token operator">=</span> ImageDataGenerator<span class="token punctuation">(</span>
  	rotation_range <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span>
  	width_shift_range <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
  	height_shift_range <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
  	shear_range <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
  	zoom_range <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
  	horizontal_flip <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token punctuation">)</span>
</code></pre></div><h4 id="create-model"><a href="#create-model" class="header-anchor">#</a> Create Model</h4> <p>When the CNN model is trained fully on a synthetic dataset, it witnesses a significant performance drop when testing on real-world data, compared to when applied to another synthetic validation set. It alludes to discrepancies between the distributions of synthetic and real-world examples. They propose to decompose the <em>N CNN</em> layers into two sub-networks to be learned sequentially:</p> <ul><li><p><strong>Unsupervised cross-domain sub-network <mjx-container jax="CHTML" class="MathJax"><mjx-math class=" MJX-TEX"><mjx-TeXAtom><mjx-msub><mjx-mi noIC="true" class="mjx-i"><mjx-c c="C"></mjx-c></mjx-mi><mjx-script style="vertical-align:-0.15em;"><mjx-mi size="s" class="mjx-i"><mjx-c c="u"></mjx-c></mjx-mi></mjx-script></mjx-msub></mjx-TeXAtom></mjx-math></mjx-container></strong>, which consists of the first <em>K</em> layers of <em>CNN</em>. It accounts for extracting low-level visual features shared by both syn- thetic and real-world data domains. <mjx-container jax="CHTML" class="MathJax"><mjx-math class=" MJX-TEX"><mjx-TeXAtom><mjx-msub><mjx-mi noIC="true" class="mjx-i"><mjx-c c="C"></mjx-c></mjx-mi><mjx-script style="vertical-align:-0.15em;"><mjx-mi size="s" class="mjx-i"><mjx-c c="u"></mjx-c></mjx-mi></mjx-script></mjx-msub></mjx-TeXAtom></mjx-math></mjx-container> will be trained in a unsupervised way, using unlabeled data from both domains. It constitutes the crucial step that further minimizes the low-level feature gap, beyond the previous data augmentation efforts.</p></li> <li><p><strong>Supervised domain-specific sub-network <mjx-container jax="CHTML" class="MathJax"><mjx-math class=" MJX-TEX"><mjx-TeXAtom><mjx-msub><mjx-mi noIC="true" class="mjx-i"><mjx-c c="C"></mjx-c></mjx-mi><mjx-script style="vertical-align:-0.15em;"><mjx-mi size="s" class="mjx-i"><mjx-c c="s"></mjx-c></mjx-mi></mjx-script></mjx-msub></mjx-TeXAtom></mjx-math></mjx-container></strong>, which consists of the remaining <em>N âˆ’ K</em> layers. It accounts for learning higher-level discriminative features for classi- fication, based on the shared features from <mjx-container jax="CHTML" class="MathJax"><mjx-math class=" MJX-TEX"><mjx-TeXAtom><mjx-msub><mjx-mi noIC="true" class="mjx-i"><mjx-c c="C"></mjx-c></mjx-mi><mjx-script style="vertical-align:-0.15em;"><mjx-mi size="s" class="mjx-i"><mjx-c c="u"></mjx-c></mjx-mi></mjx-script></mjx-msub></mjx-TeXAtom></mjx-math></mjx-container>. <mjx-container jax="CHTML" class="MathJax"><mjx-math class=" MJX-TEX"><mjx-TeXAtom><mjx-msub><mjx-mi noIC="true" class="mjx-i"><mjx-c c="C"></mjx-c></mjx-mi><mjx-script style="vertical-align:-0.15em;"><mjx-mi size="s" class="mjx-i"><mjx-c c="s"></mjx-c></mjx-mi></mjx-script></mjx-msub></mjx-TeXAtom></mjx-math></mjx-container> will be trained in a supervised way, using labeled data from the synthetic domain only.</p></li></ul> <p>Firstly we modify the order of picture channels to avoid <code>OverflowError</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> keras <span class="token keyword">import</span> backend <span class="token keyword">as</span> K

K<span class="token punctuation">.</span>set_image_data_format<span class="token punctuation">(</span><span class="token string">'channels_last'</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Note the difference about the format which <code>keras</code> use in different versions.</p> <div class="language-python extra-class"><pre class="language-python"><code>K<span class="token punctuation">.</span>set_image_dim_ordering<span class="token punctuation">(</span><span class="token string">'tf'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span> K<span class="token punctuation">.</span>set_image_data_format<span class="token punctuation">(</span><span class="token string">'channels_last'</span><span class="token punctuation">)</span>
K<span class="token punctuation">.</span>set_image_dim_ordering<span class="token punctuation">(</span><span class="token string">'th'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span> K<span class="token punctuation">.</span>set_image_data_format<span class="token punctuation">(</span><span class="token string">'channels_first'</span><span class="token punctuation">)</span>
</code></pre></div></div> <p>Secondly code create model function to define the architecture of the CNN layers.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Sequential
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>normalization <span class="token keyword">import</span> BatchNormalization
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Dense<span class="token punctuation">,</span> Dropout<span class="token punctuation">,</span> Flatten<span class="token punctuation">,</span> Conv2D<span class="token punctuation">,</span> MaxPooling2D <span class="token punctuation">,</span> UpSampling2D <span class="token punctuation">,</span>Conv2DTranspose

<span class="token keyword">def</span> <span class="token function">create_model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  	model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>

  	<span class="token comment">#Cu Layers </span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">'relu'</span><span class="token punctuation">,</span> input_shape <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>MaxPooling2D<span class="token punctuation">(</span>pool_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> kernel_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>MaxPooling2D<span class="token punctuation">(</span>pool_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2DTranspose<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">'relu'</span><span class="token punctuation">,</span> padding <span class="token operator">=</span> <span class="token string">'same'</span><span class="token punctuation">,</span> kernel_initializer <span class="token operator">=</span> <span class="token string">'uniform'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>UpSampling2D<span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2DTranspose<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strides <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">'relu'</span><span class="token punctuation">,</span> padding <span class="token operator">=</span> <span class="token string">'same'</span><span class="token punctuation">,</span> kernel_initializer <span class="token operator">=</span> <span class="token string">'uniform'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>UpSampling2D<span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  	<span class="token comment">#Cs Layers</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Conv2D<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">2383</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	model<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>font_names<span class="token punctuation">)</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">'softmax'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
  	<span class="token keyword">return</span> model
</code></pre></div><p>Then create and compile model using Gradient descent (with momentum) optimizer with the CNN architecture network we created just now.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> keras <span class="token keyword">import</span> optimizers

batch_size <span class="token operator">=</span> <span class="token number">128</span>
epochs <span class="token operator">=</span> <span class="token number">50</span>
model<span class="token operator">=</span> create_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
opt <span class="token operator">=</span> optimizers<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>lr <span class="token operator">=</span> <span class="token number">0.01</span><span class="token punctuation">,</span> decay <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">,</span> momentum <span class="token operator">=</span> <span class="token number">0.9</span><span class="token punctuation">,</span> nesterov <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss <span class="token operator">=</span> <span class="token string">'mean_squared_error'</span><span class="token punctuation">,</span> optimizer <span class="token operator">=</span> opt<span class="token punctuation">,</span> metrics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>Periodically save my model to disk and get a view on internal states and statistics of a model during training.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> keras <span class="token keyword">import</span> callbacks

model_path <span class="token operator">=</span> <span class="token string">&quot;model_store_path&quot;</span>
my_callbacks <span class="token operator">=</span> <span class="token punctuation">[</span>
  	callbacks<span class="token punctuation">.</span>EarlyStopping<span class="token punctuation">(</span>monitor <span class="token operator">=</span> <span class="token string">'val_loss'</span><span class="token punctuation">,</span> min_delta <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> patience <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> mode <span class="token operator">=</span> <span class="token string">'min'</span><span class="token punctuation">)</span>
  	callbacks<span class="token punctuation">.</span>ModelCheckpoint<span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> monitor <span class="token operator">=</span> <span class="token string">'val_loss'</span><span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> save_best_only <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> mode <span class="token operator">=</span> <span class="token string">'min'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
  	trainX<span class="token punctuation">,</span>
  	trainY<span class="token punctuation">,</span>
  	shuffle <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    batch_size <span class="token operator">=</span> batch_size<span class="token punctuation">,</span>
    epochs <span class="token operator">=</span> epochs<span class="token punctuation">,</span>
    verbose <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    validation_data <span class="token operator">=</span> <span class="token punctuation">(</span>testX<span class="token punctuation">,</span> testY<span class="token punctuation">)</span><span class="token punctuation">,</span>
  	callbacks <span class="token operator">=</span> my_callbacks
<span class="token punctuation">)</span>
</code></pre></div><h3 id="evaluate"><a href="#evaluate" class="header-anchor">#</a> Evaluate</h3> <p>It's necessary to evaluate a model after training to test whether it has meet our exceptions. If not, it means there would be some problem with our datasets or arguments used to compile.</p> <h4 id="load-model"><a href="#load-model" class="header-anchor">#</a> Load Model</h4> <p>Load the model from <code>model_store_path</code> and print model evaluation information on the screen.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> load_model

model_path <span class="token operator">=</span> <span class="token string">&quot;model_store_path&quot;</span>
model <span class="token operator">=</span> load_model<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
score <span class="token operator">=</span> model<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>testX<span class="token punctuation">,</span> testY<span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Test loss -&gt;'</span><span class="token punctuation">,</span> score<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Test accuracy -&gt;'</span><span class="token punctuation">,</span> score<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="load-image"><a href="#load-image" class="header-anchor">#</a> Load Image</h4> <p>Load the test image from <code>image_path</code> and preprocess with <code>blur_img</code> function, conver image to array.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> PIL
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image <span class="token keyword">import</span> img_to_array

img_path <span class="token operator">=</span> <span class="token string">&quot;image_path&quot;</span>

org_img <span class="token operator">=</span> PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span>
pil_img <span class="token operator">=</span> blur_image<span class="token punctuation">(</span>org_img<span class="token punctuation">)</span>
pil_img <span class="token operator">=</span> img_to_array<span class="token punctuation">(</span>pil_img<span class="token punctuation">)</span>
</code></pre></div><h4 id="inference"><a href="#inference" class="header-anchor">#</a> Inference</h4> <p>Firstly code the lable restore function to convert font name from integer to string.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">rev_conv_label</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> font_names<span class="token punctuation">[</span>label<span class="token punctuation">]</span>
</code></pre></div><p>Then use loaded model to predict image array.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pil_img<span class="token punctuation">)</span>
data <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>data<span class="token punctuation">,</span> dtype <span class="token operator">=</span> <span class="token string">&quot;float&quot;</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.0</span>
y <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>Lastly, show the prediction results.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>cm <span class="token keyword">as</span> cm
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pylab <span class="token keyword">as</span> plt

label <span class="token operator">=</span> rev_conv_label<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
fig<span class="token punctuation">,</span> ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
ax<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>org_img<span class="token punctuation">,</span> interpolation <span class="token operator">=</span> <span class="token string">'nearest'</span><span class="token punctuation">,</span> cmap <span class="token operator">=</span> cm<span class="token punctuation">.</span>gray<span class="token punctuation">)</span>
ax<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> label<span class="token punctuation">,</span> bbox <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'facecolor'</span><span class="token punctuation">:</span> <span class="token string">'white'</span><span class="token punctuation">,</span> <span class="token string">'pad'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">CC BY-SA 4.0 / Last Updated:</span> <span class="time">1/28/2021, 9:54:53 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/programming/computer-vision/" class="prev">
        Computer Vision
      </a></span> <span class="next"><a href="/security/cyber/">
        Cyber
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.041ccf91.js" defer></script><script src="/assets/js/2.30d40f56.js" defer></script><script src="/assets/js/24.63f564f1.js" defer></script><script src="/assets/js/3.9032db0e.js" defer></script>
  </body>
</html>
