<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenCV | Unbinilium&#39;s 📖</title>
    <meta name="description" content="Unbinilium&#39;s personal knowledge book">
    <meta name="generator" content="VuePress 1.4.0">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
  <link rel="manifest" href="/manifest.json" crossorigin="use-credentials">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="icon" href="/favicon.ico">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#fff">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="msapplication-TileColor" content="#fff">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon.png">
    
    <link rel="preload" href="/assets/css/0.styles.4b7e2858.css" as="style"><link rel="preload" href="/assets/js/app.1a1c18e0.js" as="script"><link rel="preload" href="/assets/js/2.f5613a4d.js" as="script"><link rel="preload" href="/assets/js/27.481ab05e.js" as="script"><link rel="preload" href="/assets/js/3.0f135a11.js" as="script"><link rel="prefetch" href="/assets/js/10.4e211c24.js"><link rel="prefetch" href="/assets/js/11.4de2d28f.js"><link rel="prefetch" href="/assets/js/12.9316d203.js"><link rel="prefetch" href="/assets/js/13.5951b3ce.js"><link rel="prefetch" href="/assets/js/14.adc349e6.js"><link rel="prefetch" href="/assets/js/15.de14786f.js"><link rel="prefetch" href="/assets/js/16.69458723.js"><link rel="prefetch" href="/assets/js/17.d4d4d50a.js"><link rel="prefetch" href="/assets/js/18.7e9a3f9b.js"><link rel="prefetch" href="/assets/js/19.b93e5a39.js"><link rel="prefetch" href="/assets/js/20.5a20d8ae.js"><link rel="prefetch" href="/assets/js/21.14b28521.js"><link rel="prefetch" href="/assets/js/22.4103ef3f.js"><link rel="prefetch" href="/assets/js/23.0310c61b.js"><link rel="prefetch" href="/assets/js/24.988e1c17.js"><link rel="prefetch" href="/assets/js/25.e5cc4252.js"><link rel="prefetch" href="/assets/js/26.93266c94.js"><link rel="prefetch" href="/assets/js/28.29ef28f3.js"><link rel="prefetch" href="/assets/js/29.95a736b7.js"><link rel="prefetch" href="/assets/js/30.503d1a49.js"><link rel="prefetch" href="/assets/js/31.0a42eabb.js"><link rel="prefetch" href="/assets/js/32.5a9323af.js"><link rel="prefetch" href="/assets/js/33.6c1aa0e5.js"><link rel="prefetch" href="/assets/js/34.c3aa7093.js"><link rel="prefetch" href="/assets/js/35.86facf3c.js"><link rel="prefetch" href="/assets/js/36.39073e68.js"><link rel="prefetch" href="/assets/js/37.f7e50974.js"><link rel="prefetch" href="/assets/js/38.27d8a2b2.js"><link rel="prefetch" href="/assets/js/39.7d37c475.js"><link rel="prefetch" href="/assets/js/4.6dee130a.js"><link rel="prefetch" href="/assets/js/5.cd27f5b5.js"><link rel="prefetch" href="/assets/js/6.817cc68b.js"><link rel="prefetch" href="/assets/js/7.f3e1032f.js"><link rel="prefetch" href="/assets/js/8.0ca25d1a.js"><link rel="prefetch" href="/assets/js/9.bef03a53.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4b7e2858.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Unbinilium's 📖</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Book
</a></div><div class="nav-item"><a href="https://unbinilium.me/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Book
</a></div><div class="nav-item"><a href="https://unbinilium.me/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Coding</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Programming</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/programming/opencv/" class="active sidebar-link">OpenCV</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/programming/opencv/#add-mask-to-faces" class="sidebar-link">Add mask to faces</a></li><li class="sidebar-sub-header"><a href="/programming/opencv/#compute-with-gpu" class="sidebar-link">Compute with GPU</a></li></ul></li><li><a href="/programming/tensorflow/" class="sidebar-link">Tensorflow</a></li><li><a href="/programming/pytorch/" class="sidebar-link">PyTorch</a></li><li><a href="/programming/leet-code/" class="sidebar-link">Leet Code</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Software</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Design</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Writing</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Collection</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="add-mask-to-faces"><a href="#add-mask-to-faces" class="header-anchor">#</a> Add mask to faces</h2> <p>As the death toll from the Wuhan coronavirus still risen, I felt anxious and helpless through everyone here were talking and laughing on New Year's Eve. Not sure what should I do and I just wrote this <em>python3</em> program to make people aware of the importance of wearing respirator masks when defeating the virus.</p> <p>In this program, we use <code>CascadeClassifier</code> to add respirators masks to the recognized faces in the capture. Before everything start, we have to import the necessary packages:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> argparse
<span class="token keyword">import</span> cv2
</code></pre></div><p>We use <code>argparse</code> to construct the argument parse for more flexible usage. The respirator image cloud be found on <em>eBay</em>, <em>Google</em>... and transparent background required as <code>.png</code> format. Firstly we need a <code>.xml</code> file as trained module:</p> <div class="language- extra-class"><pre class="language-text"><code>haarcascade_frontalface_default.xml
</code></pre></div><p>It could be found at OpenCV official git repository at:</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://github.com/opencv/opencv/tree/master/data/haarcascade" target="_blank" rel="noopener noreferrer">https://github.com/opencv/opencv/tree/master/data/haarcascade<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="language-python extra-class"><pre class="language-python"><code>ap <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
ap<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'--camera'</span><span class="token punctuation">,</span> <span class="token builtin">type</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">'camera device index'</span><span class="token punctuation">)</span>
ap<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-m'</span><span class="token punctuation">,</span> <span class="token string">'--mask'</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token string">'respirator.png'</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">'path of mask .png'</span><span class="token punctuation">)</span>
ap<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'--data'</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token string">'haarcascade_frontalface_default.xml'</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">'path of haarcascad data model'</span><span class="token punctuation">)</span>
ap<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-w'</span><span class="token punctuation">,</span> <span class="token string">'--width'</span><span class="token punctuation">,</span> <span class="token builtin">type</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token number">720</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">'camera frame width'</span><span class="token punctuation">)</span>
ap<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-l'</span><span class="token punctuation">,</span> <span class="token string">'--height'</span><span class="token punctuation">,</span> <span class="token builtin">type</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token number">480</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">'camera frame height'</span><span class="token punctuation">)</span>
args <span class="token operator">=</span> <span class="token builtin">vars</span><span class="token punctuation">(</span>ap<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Parse the arguments, open camera and load necessary files:</p> <div class="language-python extra-class"><pre class="language-python"><code>cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'camera'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
cap<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_WIDTH<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
cap<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_HEIGHT<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'mask'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>IMREAD_UNCHANGED<span class="token punctuation">)</span>
face_cascade <span class="token operator">=</span> cv2<span class="token punctuation">.</span>CascadeClassifier<span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>Create tracker bar based on the arguments we may use:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">callBack</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

cv2<span class="token punctuation">.</span>createTrackbar<span class="token punctuation">(</span><span class="token string">'scale_factor'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> callBack<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>createTrackbar<span class="token punctuation">(</span><span class="token string">'min_neighbors'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> callBack<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>createTrackbar<span class="token punctuation">(</span><span class="token string">'min_size'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callBack<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>createTrackbar<span class="token punctuation">(</span><span class="token string">'max_size'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">,</span> <span class="token number">360</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callBack<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>createTrackbar<span class="token punctuation">(</span><span class="token string">'mask_y_s_k'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> callBack<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>createTrackbar<span class="token punctuation">(</span><span class="token string">'mask_y_e_k'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> callBack<span class="token punctuation">)</span>
</code></pre></div><p>Before start frame processing, let's understand <code>CascadeClassifier</code> deeper. Here I just give a simple reference to the <a href="https://docs.opencv.org/3.4/db/d28/tutorial_cascade_classifier.html" target="_blank" rel="noopener noreferrer">official introduction<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>Object Detection using Haar feature-based cascade classifiers is an effective object detection method proposed by Paul Viola and Michael Jones in their paper, It is a machine learning based approach where a cascade function is trained from a lot of positive and negative images. It is then used to detect objects in other images.</p> <p>Here we will work with face detection. Initially, the algorithm needs a lot of positive images and negative images to train the classifier. Then we need to extract features from it.</p> <p>Then let's code a function <code>transparentOverlay</code> for blending frame and respirator image first, we loop over all pixels and apply the blending equation:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">transparentOverlay</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> overlay<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token keyword">for</span> col <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>overlay<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> row <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>overlay<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> col <span class="token operator">&lt;=</span> src<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> row <span class="token operator">&lt;=</span> src<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                alpha <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>overlay<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">)</span>
                src<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">[</span>row<span class="token punctuation">]</span> <span class="token operator">=</span> alpha <span class="token operator">*</span> overlay<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> alpha<span class="token punctuation">)</span> <span class="token operator">*</span> src<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">[</span>row<span class="token punctuation">]</span>
    <span class="token keyword">return</span> src
</code></pre></div><p>Finally we process every frame from capture, recognize the faces, resize the respirators to fit the faces and apply the transparent overlay to each frame:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">while</span> cap<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">(</span>ret<span class="token punctuation">,</span> frame<span class="token punctuation">)</span> <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>min_size<span class="token punctuation">,</span> max_size<span class="token punctuation">)</span> <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTrackbarPos<span class="token punctuation">(</span><span class="token string">'min_size'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>getTrackbarPos<span class="token punctuation">(</span><span class="token string">'max_size'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span> <span class="token keyword">in</span> face_cascade<span class="token punctuation">.</span>detectMultiScale<span class="token punctuation">(</span>image <span class="token operator">=</span> frame<span class="token punctuation">,</span> scaleFactor <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> cv2<span class="token punctuation">.</span>getTrackbarPos<span class="token punctuation">(</span><span class="token string">'scale_factor'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">,</span> minNeighbors <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTrackbarPos<span class="token punctuation">(</span><span class="token string">'min_neighbors'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> minSize <span class="token operator">=</span> <span class="token punctuation">(</span>min_size<span class="token punctuation">,</span> min_size<span class="token punctuation">)</span><span class="token punctuation">,</span> maxSize <span class="token operator">=</span> <span class="token punctuation">(</span>max_size<span class="token punctuation">,</span> max_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> w <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> h <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token punctuation">(</span>overlay_y_s<span class="token punctuation">,</span> overlay_y_e<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y <span class="token operator">+</span> h <span class="token operator">*</span> cv2<span class="token punctuation">.</span>getTrackbarPos<span class="token punctuation">(</span><span class="token string">'mask_y_s_k'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y <span class="token operator">+</span> h <span class="token operator">*</span> cv2<span class="token punctuation">.</span>getTrackbarPos<span class="token punctuation">(</span><span class="token string">'mask_y_e_k'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span>
            mask_resized <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>src <span class="token operator">=</span> mask<span class="token punctuation">,</span> dsize <span class="token operator">=</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> overlay_y_e <span class="token operator">-</span> overlay_y_s<span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation <span class="token operator">=</span> cv2<span class="token punctuation">.</span>INTER_CUBIC<span class="token punctuation">)</span>
            transparentOverlay<span class="token punctuation">(</span>src <span class="token operator">=</span> frame<span class="token punctuation">[</span>overlay_y_s<span class="token punctuation">:</span>overlay_y_e<span class="token punctuation">,</span> x<span class="token punctuation">:</span>x <span class="token operator">+</span> w<span class="token punctuation">]</span><span class="token punctuation">,</span> overlay <span class="token operator">=</span> mask_resized<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>winname <span class="token operator">=</span> <span class="token string">'respirator'</span><span class="token punctuation">,</span> mat <span class="token operator">=</span> frame<span class="token punctuation">)</span>
    <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
</code></pre></div><p>Forming a sound habit, close capture and destroy windows when program ended:</p> <div class="language-python extra-class"><pre class="language-python"><code>cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="compute-with-gpu"><a href="#compute-with-gpu" class="header-anchor">#</a> Compute with GPU</h2> <p>First your OpenCV should be compiled with CUDA (<em>and OpenGL</em>) support to test all this features. Detect your CUDA hardware with OpenCV CUDA by:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/core.hpp&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/cudaarithm.hpp&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token operator">::</span>cuda<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printShortCudaDeviceInfo</span><span class="token punctuation">(</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cuda_devices_number <span class="token operator">=</span> <span class="token function">getCudaEnabledDeviceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;CUDA Device(s) Number: &quot;</span><span class="token operator">&lt;&lt;</span> cuda_devices_number <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    DeviceInfo _deviceInfo<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> _isd_evice_compatible <span class="token operator">=</span> _deviceInfo<span class="token punctuation">.</span><span class="token function">isCompatible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;CUDA Device(s) Compatible: &quot;</span> <span class="token operator">&lt;&lt;</span> _isd_evice_compatible <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Run and debug the code in your C++ IDE and see if it shows like this below to check hardware compatibility of CUDA.</p> <div class="language- extra-class"><pre class="language-text"><code>Device 0:  &quot;GeForce GTX 1650&quot;  4096Mb, sm_75, Driver/Runtime ver.10.10/10.10
CUDA Device(s) Number: 1
CUDA Device(s) Compatible: 1
</code></pre></div><p>Obviously when adding CUDA support to your code, nothing is more important than adding the <strong>header</strong> first. All the <code>.hpp</code> file stored as the install path like:</p> <div class="language- extra-class"><pre class="language-text"><code>~\include\opencv2
~\include\opencv2\cudalegacy
</code></pre></div><p>For example we add the headers below when liner blending two images:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/core.hpp&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui.hpp&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>

<span class="token comment">//Add CUDA support</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/cudaarithm.hpp&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/cudafeatures2d.hpp&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token operator">::</span>cuda<span class="token punctuation">;</span>
</code></pre></div><p>Then we should declare the difference between the basic class <code>cv::Mat</code> and <code>cv::gpu::GpuMat</code>. Firstly <code>GpuMat</code> added two member function as:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>cv<span class="token operator">::</span>gpu<span class="token operator">::</span>GpuMat<span class="token operator">::</span><span class="token function">upload</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>Mat<span class="token operator">::</span>InputArray arr<span class="token punctuation">)</span>
cv<span class="token operator">::</span>gpu<span class="token operator">::</span>GpuMat<span class="token operator">::</span><span class="token function">download</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>OutputArray dst<span class="token punctuation">)</span>
</code></pre></div><p>We use them to link <em>RAM</em> with <em>GPU Memory</em> but actually it not temporarily link, because <code>Mat</code> and <code>GpuMat</code> both have data pointer and both data pointer pointed to different memory block which causes memory copy between RAM and GPU Memory.</p> <p>It seems for better access speed, <code>GpuMat</code> only supports 2D array and filled with blank bytes in the end in empty or not fully filled cols to align the RAM and the real memory of a row is stored in member <code>cv::gpu::GpuMat::step</code>.</p> <p>Let's look deeper, the function <code>cv::gpu::GpuMat::upload</code> and <code>cv::gpu::GpuMat::download</code> in OpenCV 3 is actually designed for asynchronous processing form its definition:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">upload</span><span class="token punctuation">(</span>InputArray arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">upload</span><span class="token punctuation">(</span>InputArray arr<span class="token punctuation">,</span> Stream<span class="token operator">&amp;</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">download</span><span class="token punctuation">(</span>OutputArray dst<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">download</span><span class="token punctuation">(</span>OutputArray dst<span class="token punctuation">,</span> Stream<span class="token operator">&amp;</span> stream<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
</code></pre></div><p>And now let's see 3 special examples to learn how the <code>GpuMat</code> is structed in different ways(<a href="https://docs.opencv.org/4.1.2/d0/d60/classcv_1_1cuda_1_1GpuMat.html" target="_blank" rel="noopener noreferrer"><em>GpuMat Class Reference</em><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">//Default constructor</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span>GpuMat<span class="token operator">::</span><span class="token function">GpuMat</span><span class="token punctuation">(</span>GpuMat<span class="token operator">::</span>Allocator<span class="token operator">*</span> allocator <span class="token operator">=</span> GpuMat<span class="token operator">::</span><span class="token function">defaultAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//Constructs GpuMat of the specified size and type</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span>GpuMat<span class="token operator">::</span><span class="token function">GpuMat</span><span class="token punctuation">(</span><span class="token keyword">int</span> rows<span class="token punctuation">,</span> <span class="token keyword">int</span> cols<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> Scalar s<span class="token punctuation">,</span> GpuMat<span class="token operator">::</span>Allocator<span class="token operator">*</span> allocator <span class="token operator">=</span> GpuMat<span class="token operator">::</span><span class="token function">defaultAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//Builds GpuMat from host memory (Blocking call)</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span>GpuMat<span class="token operator">::</span><span class="token function">GpuMat</span><span class="token punctuation">(</span>InputArray arr<span class="token punctuation">,</span> GpuMat<span class="token operator">::</span>Allocator<span class="token operator">*</span> allocator <span class="token operator">=</span> GpuMat<span class="token operator">::</span><span class="token function">defaultAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>We have to declare how copy works between <code>GpuMat</code>. There're 2 types of copying, one is <em>shallow copy</em> and another is <em>deep copy</em>. Examples here:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">//Shallow copy, allocate data pointer and GPU(Memory)-GPU(Memory)</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span>GpuMat dst1 <span class="token operator">=</span> dst0<span class="token punctuation">;</span>

<span class="token comment">//Deep copy, allocate memory and GPU(Memory)-GPU(Memory)</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span>GpuMat dst0<span class="token punctuation">,</span> dst1<span class="token punctuation">;</span>
dst0<span class="token punctuation">.</span><span class="token function">copyTo</span><span class="token punctuation">(</span>dst1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Deep copy, allocate memory and upload to CPU(RAM)-GPU(Memory)</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span>GpuMat dst1<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>dst1<span class="token punctuation">)</span><span class="token punctuation">;</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span>GpuMat dst1 <span class="token operator">=</span> dst0<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>OpenCV designed <em>shallow copy</em> to only copy the <strong>header</strong> and <strong>data pointer</strong> which uses same real memory and affect each other when perform a change in one of each, only useable in same memory space. The different of <em>deep copy</em> is its <strong>temporarily copy the data</strong> with no affection of each when one is changed, not restricted to the type of the memory whether RAM or GPU Memory.</p> <p>Now we found that our main idea to use CUDA is increase the performance when processing data with the complex algorithm but not a huge amount of data in real time. Because too many data transferred instantly causes IO overflow and transferring data from RAM and GPU Memory requires amount of computing performance and increases its delay, through OpenCV developer designed <code>PtrStepSz</code> and <code>PtrStep</code> two light-weighted class in OpenCV2 to reduce copying data size for fast and low latency computing.</p> <p>I still confused about how to pass <code>VideoCapture</code> stream directly to GPU Memory, in that case we don't need to <em>upload</em> or <em>download</em> frames from GPU Memory to RAM, just grab frames from stream in <code>GpuMat</code>. Because NVIDIA Video Decoder(<em>NVCUVID</em>) is deprecated and the funtion below is no longer working.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>cv<span class="token operator">::</span>Ptr<span class="token operator">&lt;</span>cv<span class="token operator">::</span>cudacodec<span class="token operator">::</span>VideoReader<span class="token operator">&gt;</span> d_reader <span class="token operator">=</span> cv<span class="token operator">::</span>cudacodec<span class="token operator">::</span><span class="token function">createVideoReader</span><span class="token punctuation">(</span>fname<span class="token punctuation">)</span>
</code></pre></div><p>For older CUDA version 8 the <code>createVideoReader()</code> would pass camera frames directly to GPU Memory.</p> <p>Here I wrote a function that grab frame from streams and liner blend with a static image part example using OpenCV CUDA:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>Mat video_frame_temp<span class="token punctuation">,</span> temp_frame_downloaded<span class="token punctuation">;</span>
GpuMat mask_image<span class="token punctuation">,</span> video_frame<span class="token punctuation">,</span> temp_frame<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">initWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">namedWindow</span><span class="token punctuation">(</span>WINDOW_NAME<span class="token punctuation">,</span> WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">blendFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">getWindowProperty</span><span class="token punctuation">(</span>WINDOW_NAME<span class="token punctuation">,</span> WINDOW_AUTOSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>        
        <span class="token function">grabFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>video_frame_temp<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        video_frame<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>video_frame_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">blendImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">outputImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">waitKey</span><span class="token punctuation">(</span>GRAB_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">grabFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    capture <span class="token operator">&gt;&gt;</span> video_frame_temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">blendImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cv<span class="token operator">::</span>cuda<span class="token operator">::</span><span class="token function">addWeighted</span><span class="token punctuation">(</span>video_frame<span class="token punctuation">,</span> ALPHA<span class="token punctuation">,</span> mask_image<span class="token punctuation">,</span> BETA<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> temp_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">outputImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    temp_frame<span class="token punctuation">.</span><span class="token function">download</span><span class="token punctuation">(</span>temp_frame_downloaded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span>WINDOW_NAME<span class="token punctuation">,</span> temp_frame_downloaded<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>With <em>OpenGL</em> support, we could easily write using built-in function:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">namedWindow</span><span class="token punctuation">(</span>WINDOW_NAME<span class="token punctuation">,</span> WINDOW_AUTOSIZE<span class="token punctuation">)</span>
<span class="token function">namedWindow</span><span class="token punctuation">(</span>WINDOW_NAME<span class="token punctuation">,</span> WINDOW_OPENGL<span class="token punctuation">)</span>
</code></pre></div><p>Using <code>WINDOW_OPENGL</code> and then we could access <code>temp_frame</code> directly by enabling function <code>imshow</code> to directly access to <em>GPU Memory</em>. For example <code>outputImage</code> could be write like this:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">outputImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span>WINDOW_NAME<span class="token punctuation">,</span> temp_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>It saves valuable time when copying GPU Memory to RAM and makes processed image displayed faster.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">CC BY-SA 4.0 / Last Updated:</span> <span class="time">3/19/2020, 6:46:19 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/coding/css/" class="prev">
        CSS
      </a></span> <span class="next"><a href="/programming/tensorflow/">
        Tensorflow
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.1a1c18e0.js" defer></script><script src="/assets/js/2.f5613a4d.js" defer></script><script src="/assets/js/27.481ab05e.js" defer></script><script src="/assets/js/3.0f135a11.js" defer></script>
  </body>
</html>
