<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Computer Vision | Unbinilium&#39;s ðŸ“–</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="manifest" href="/manifest.json" crossorigin="use-credentials">
    <link rel="shortcut icon" type="image/png" href="/favicon.png">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <meta name="description" content="Unbinilium's personal knowledge book">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="msapplication-TileColor" content="#fff">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon.png">
    <meta property="og:title" content="Unbinilium's ðŸ“–">
    <meta property="og:description" content="Unbinilium's personal knowledge book">
    <meta property="og:url" content="https://xn--vt8h.unbinilium.me/">
    <meta property="og:image" content="https://xn--vt8h.unbinilium.me/open_graph_logo.png">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Unbinilium's ðŸ“–">
    
    <link rel="preload" href="/assets/css/0.styles.c86a7820.css" as="style"><link rel="preload" href="/assets/js/app.041ccf91.js" as="script"><link rel="preload" href="/assets/js/2.30d40f56.js" as="script"><link rel="preload" href="/assets/js/23.db0b25e6.js" as="script"><link rel="preload" href="/assets/js/3.9032db0e.js" as="script"><link rel="prefetch" href="/assets/js/10.469d6b72.js"><link rel="prefetch" href="/assets/js/11.c6524284.js"><link rel="prefetch" href="/assets/js/12.ce88ebf9.js"><link rel="prefetch" href="/assets/js/13.ab2b84d3.js"><link rel="prefetch" href="/assets/js/14.fe038601.js"><link rel="prefetch" href="/assets/js/15.a0555c26.js"><link rel="prefetch" href="/assets/js/16.f55579dd.js"><link rel="prefetch" href="/assets/js/17.ebad19b1.js"><link rel="prefetch" href="/assets/js/18.fadf84da.js"><link rel="prefetch" href="/assets/js/19.43a71af3.js"><link rel="prefetch" href="/assets/js/20.946ff141.js"><link rel="prefetch" href="/assets/js/21.811b4ca6.js"><link rel="prefetch" href="/assets/js/22.4d4a6949.js"><link rel="prefetch" href="/assets/js/24.63f564f1.js"><link rel="prefetch" href="/assets/js/25.ef3461c4.js"><link rel="prefetch" href="/assets/js/26.6354f890.js"><link rel="prefetch" href="/assets/js/27.1b44817a.js"><link rel="prefetch" href="/assets/js/28.30ebeba7.js"><link rel="prefetch" href="/assets/js/29.fd0c526c.js"><link rel="prefetch" href="/assets/js/30.3294a55b.js"><link rel="prefetch" href="/assets/js/4.5e92b263.js"><link rel="prefetch" href="/assets/js/5.665901b5.js"><link rel="prefetch" href="/assets/js/6.6ba3b61b.js"><link rel="prefetch" href="/assets/js/7.d31a3cd7.js"><link rel="prefetch" href="/assets/js/8.d4661bf2.js"><link rel="prefetch" href="/assets/js/9.168171d4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c86a7820.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Unbinilium's ðŸ“–</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link router-link-active">
  Book
</a></div><div class="nav-item"><a href="https://unbinilium.me/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link router-link-active">
  Book
</a></div><div class="nav-item"><a href="https://unbinilium.me/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Coding</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Programming</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/programming/algorithm/" class="sidebar-link">Algorithm</a></li><li><a href="/programming/computer-vision/" aria-current="page" class="active sidebar-link">Computer Vision</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/programming/computer-vision/#add-mask-to-faces" class="sidebar-link">Add mask to faces</a></li><li class="sidebar-sub-header"><a href="/programming/computer-vision/#compute-with-gpu" class="sidebar-link">Compute with GPU</a></li><li class="sidebar-sub-header"><a href="/programming/computer-vision/#color-area" class="sidebar-link">Color area</a></li></ul></li><li><a href="/programming/machine-learning/" class="sidebar-link">Machine Learning</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Security</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Software</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Design</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Writing</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Collection</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>See Also</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>Computer vision is an interdisciplinary scientific field that deals with how computers can gain high-level understanding from digital images or videos. Here I note some tricks or experience about OpenCV, OpenMV and other computer vision libraries.</p> <h2 id="add-mask-to-faces"><a href="#add-mask-to-faces" class="header-anchor">#</a> Add mask to faces</h2> <p>As the death toll from the Wuhan coronavirus still risen, I felt anxious and helpless through everyone here were talking and laughing on New Year's Eve. Not sure what should I do and I just wrote this <em>python3</em> program to make people aware of the importance of wearing respirator masks when defeating the virus.</p> <p>In this program, we use <code>CascadeClassifier</code> to add respirators masks to the recognized faces in the capture. Before everything start, we have to import the necessary packages:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> argparse
<span class="token keyword">import</span> cv2
</code></pre></div><p>We use <code>argparse</code> to construct the argument parse for more flexible usage. The respirator image cloud be found on <em>eBay</em>, <em>Google</em>... and transparent background required as <code>.png</code> format. Firstly we need a <code>.xml</code> file as trained module:</p> <div class="language- extra-class"><pre class="language-text"><code>haarcascade_frontalface_default.xml
</code></pre></div><p>It could be found at OpenCV official git repository at:</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://github.com/opencv/opencv/tree/master/data/haarcascade" target="_blank" rel="noopener noreferrer">opencv/data/haarcascade<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <div class="language-python extra-class"><pre class="language-python"><code>ap <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
ap<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'--camera'</span><span class="token punctuation">,</span> <span class="token builtin">type</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">'camera device index'</span><span class="token punctuation">)</span>
ap<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-m'</span><span class="token punctuation">,</span> <span class="token string">'--mask'</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token string">'respirator.png'</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">'path of mask .png'</span><span class="token punctuation">)</span>
ap<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'--data'</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token string">'haarcascade_frontalface_default.xml'</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">'path of haarcascad data model'</span><span class="token punctuation">)</span>
ap<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-w'</span><span class="token punctuation">,</span> <span class="token string">'--width'</span><span class="token punctuation">,</span> <span class="token builtin">type</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token number">720</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">'camera frame width'</span><span class="token punctuation">)</span>
ap<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-l'</span><span class="token punctuation">,</span> <span class="token string">'--height'</span><span class="token punctuation">,</span> <span class="token builtin">type</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token number">480</span><span class="token punctuation">,</span> <span class="token builtin">help</span> <span class="token operator">=</span> <span class="token string">'camera frame height'</span><span class="token punctuation">)</span>
args <span class="token operator">=</span> <span class="token builtin">vars</span><span class="token punctuation">(</span>ap<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Parse the arguments, open camera and load necessary files:</p> <div class="language-python extra-class"><pre class="language-python"><code>cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'camera'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
cap<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_WIDTH<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
cap<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_HEIGHT<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'mask'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>IMREAD_UNCHANGED<span class="token punctuation">)</span>
face_cascade <span class="token operator">=</span> cv2<span class="token punctuation">.</span>CascadeClassifier<span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>Create tracker bar based on the arguments we may use:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">callBack</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

cv2<span class="token punctuation">.</span>createTrackbar<span class="token punctuation">(</span><span class="token string">'scale_factor'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> callBack<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>createTrackbar<span class="token punctuation">(</span><span class="token string">'min_neighbors'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> callBack<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>createTrackbar<span class="token punctuation">(</span><span class="token string">'min_size'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callBack<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>createTrackbar<span class="token punctuation">(</span><span class="token string">'max_size'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">,</span> <span class="token number">360</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callBack<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>createTrackbar<span class="token punctuation">(</span><span class="token string">'mask_y_s_k'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> callBack<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>createTrackbar<span class="token punctuation">(</span><span class="token string">'mask_y_e_k'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> callBack<span class="token punctuation">)</span>
</code></pre></div><p>Before start frame processing, let's understand <code>CascadeClassifier</code> deeper. Here I just give a simple reference to the <a href="https://docs.opencv.org/3.4/db/d28/tutorial_cascade_classifier.html" target="_blank" rel="noopener noreferrer">official introduction<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Object Detection using Haar feature-based cascade classifiers is an effective object detection method proposed by Paul Viola and Michael Jones in their paper, It is a machine learning based approach where a cascade function is trained from a lot of positive and negative images. It is then used to detect objects in other images.</p> <p>Here we will work with face detection. Initially, the algorithm needs a lot of positive images and negative images to train the classifier. Then we need to extract features from it.</p> <p>Then let's code a function <code>transparentOverlay</code> for blending frame and respirator image first, we loop over all pixels and apply the blending equation:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">transparentOverlay</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> overlay<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token keyword">for</span> col <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>overlay<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> row <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>overlay<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> col <span class="token operator">&lt;=</span> src<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> row <span class="token operator">&lt;=</span> src<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                alpha <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>overlay<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">)</span>
                src<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">[</span>row<span class="token punctuation">]</span> <span class="token operator">=</span> alpha <span class="token operator">*</span> overlay<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> alpha<span class="token punctuation">)</span> <span class="token operator">*</span> src<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">[</span>row<span class="token punctuation">]</span>
    <span class="token keyword">return</span> src
</code></pre></div><p>Finally we process every frame from capture, recognize the faces, resize the respirators to fit the faces and apply the transparent overlay to each frame:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">while</span> cap<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">(</span>ret<span class="token punctuation">,</span> frame<span class="token punctuation">)</span> <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>min_size<span class="token punctuation">,</span> max_size<span class="token punctuation">)</span> <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTrackbarPos<span class="token punctuation">(</span><span class="token string">'min_size'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>getTrackbarPos<span class="token punctuation">(</span><span class="token string">'max_size'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span> <span class="token keyword">in</span> face_cascade<span class="token punctuation">.</span>detectMultiScale<span class="token punctuation">(</span>image <span class="token operator">=</span> frame<span class="token punctuation">,</span> scaleFactor <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> cv2<span class="token punctuation">.</span>getTrackbarPos<span class="token punctuation">(</span><span class="token string">'scale_factor'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">,</span> minNeighbors <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTrackbarPos<span class="token punctuation">(</span><span class="token string">'min_neighbors'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> minSize <span class="token operator">=</span> <span class="token punctuation">(</span>min_size<span class="token punctuation">,</span> min_size<span class="token punctuation">)</span><span class="token punctuation">,</span> maxSize <span class="token operator">=</span> <span class="token punctuation">(</span>max_size<span class="token punctuation">,</span> max_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> w <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> h <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token punctuation">(</span>overlay_y_s<span class="token punctuation">,</span> overlay_y_e<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y <span class="token operator">+</span> h <span class="token operator">*</span> cv2<span class="token punctuation">.</span>getTrackbarPos<span class="token punctuation">(</span><span class="token string">'mask_y_s_k'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y <span class="token operator">+</span> h <span class="token operator">*</span> cv2<span class="token punctuation">.</span>getTrackbarPos<span class="token punctuation">(</span><span class="token string">'mask_y_e_k'</span><span class="token punctuation">,</span> <span class="token string">'slider'</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span>
            mask_resized <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>src <span class="token operator">=</span> mask<span class="token punctuation">,</span> dsize <span class="token operator">=</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> overlay_y_e <span class="token operator">-</span> overlay_y_s<span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation <span class="token operator">=</span> cv2<span class="token punctuation">.</span>INTER_CUBIC<span class="token punctuation">)</span>
            transparentOverlay<span class="token punctuation">(</span>src <span class="token operator">=</span> frame<span class="token punctuation">[</span>overlay_y_s<span class="token punctuation">:</span>overlay_y_e<span class="token punctuation">,</span> x<span class="token punctuation">:</span>x <span class="token operator">+</span> w<span class="token punctuation">]</span><span class="token punctuation">,</span> overlay <span class="token operator">=</span> mask_resized<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>winname <span class="token operator">=</span> <span class="token string">'respirator'</span><span class="token punctuation">,</span> mat <span class="token operator">=</span> frame<span class="token punctuation">)</span>
    <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
</code></pre></div><p>Forming a sound habit, close capture and destroy windows when program ended:</p> <div class="language-python extra-class"><pre class="language-python"><code>cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="compute-with-gpu"><a href="#compute-with-gpu" class="header-anchor">#</a> Compute with GPU</h2> <p>First your OpenCV should be compiled with CUDA (<em>and OpenGL</em>) support to test all this features. Detect your CUDA hardware with OpenCV CUDA by:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/core.hpp&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/cudaarithm.hpp&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token operator">::</span>cuda<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printShortCudaDeviceInfo</span><span class="token punctuation">(</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cuda_devices_number <span class="token operator">=</span> <span class="token function">getCudaEnabledDeviceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;CUDA Device(s) Number: &quot;</span><span class="token operator">&lt;&lt;</span> cuda_devices_number <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    DeviceInfo _deviceInfo<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> _isd_evice_compatible <span class="token operator">=</span> _deviceInfo<span class="token punctuation">.</span><span class="token function">isCompatible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;CUDA Device(s) Compatible: &quot;</span> <span class="token operator">&lt;&lt;</span> _isd_evice_compatible <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Run and debug the code in your C++ IDE and see if it shows like this below to check hardware compatibility of CUDA.</p> <div class="language- extra-class"><pre class="language-text"><code>Device 0:  &quot;GeForce GTX 1650&quot;  4096Mb, sm_75, Driver/Runtime ver.10.10/10.10
CUDA Device(s) Number: 1
CUDA Device(s) Compatible: 1
</code></pre></div><p>Obviously when adding CUDA support to your code, nothing is more important than adding the <strong>header</strong> first. All the <code>.hpp</code> file stored as the install path like:</p> <div class="language- extra-class"><pre class="language-text"><code>~\include\opencv2
~\include\opencv2\cudalegacy
</code></pre></div><p>For example we add the headers below when liner blending two images:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/core.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui.hpp&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>

<span class="token comment">//Add CUDA support</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/cudaarithm.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/cudafeatures2d.hpp&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token operator">::</span>cuda<span class="token punctuation">;</span>
</code></pre></div><p>Then we should declare the difference between the basic class <code>cv::Mat</code> and <code>cv::gpu::GpuMat</code>. Firstly <code>GpuMat</code> added two member function as:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>cv<span class="token operator">::</span>gpu<span class="token operator">::</span><span class="token class-name">GpuMat</span><span class="token operator">::</span><span class="token function">upload</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>Mat<span class="token operator">::</span>InputArray arr<span class="token punctuation">)</span>
cv<span class="token operator">::</span>gpu<span class="token operator">::</span><span class="token class-name">GpuMat</span><span class="token operator">::</span><span class="token function">download</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>OutputArray dst<span class="token punctuation">)</span>
</code></pre></div><p>We use them to link <em>RAM</em> with <em>GPU Memory</em> but actually it not temporarily link, because <code>Mat</code> and <code>GpuMat</code> both have data pointer and both data pointer pointed to different memory block which causes memory copy between RAM and GPU Memory.</p> <p>It seems for better access speed, <code>GpuMat</code> only supports 2D array and filled with blank bytes in the end in empty or not fully filled cols to align the RAM and the real memory of a row is stored in member <code>cv::gpu::GpuMat::step</code>.</p> <p>Let's look deeper, the function <code>cv::gpu::GpuMat::upload</code> and <code>cv::gpu::GpuMat::download</code> in OpenCV 3 is actually designed for asynchronous processing form its definition:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">upload</span><span class="token punctuation">(</span>InputArray arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">upload</span><span class="token punctuation">(</span>InputArray arr<span class="token punctuation">,</span> Stream<span class="token operator">&amp;</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">download</span><span class="token punctuation">(</span>OutputArray dst<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">download</span><span class="token punctuation">(</span>OutputArray dst<span class="token punctuation">,</span> Stream<span class="token operator">&amp;</span> stream<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
</code></pre></div><p>And now let's see 3 special examples to learn how the <code>GpuMat</code> is structed in different ways(<a href="https://docs.opencv.org/4.1.2/d0/d60/classcv_1_1cuda_1_1GpuMat.html" target="_blank" rel="noopener noreferrer"><em>GpuMat Class Reference</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>).</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">//Default constructor</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span><span class="token class-name">GpuMat</span><span class="token operator">::</span><span class="token function">GpuMat</span><span class="token punctuation">(</span>GpuMat<span class="token operator">::</span>Allocator<span class="token operator">*</span> allocator <span class="token operator">=</span> <span class="token class-name">GpuMat</span><span class="token operator">::</span><span class="token function">defaultAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//Constructs GpuMat of the specified size and type</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span><span class="token class-name">GpuMat</span><span class="token operator">::</span><span class="token function">GpuMat</span><span class="token punctuation">(</span><span class="token keyword">int</span> rows<span class="token punctuation">,</span> <span class="token keyword">int</span> cols<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> Scalar s<span class="token punctuation">,</span> GpuMat<span class="token operator">::</span>Allocator<span class="token operator">*</span> allocator <span class="token operator">=</span> <span class="token class-name">GpuMat</span><span class="token operator">::</span><span class="token function">defaultAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//Builds GpuMat from host memory (Blocking call)</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span><span class="token class-name">GpuMat</span><span class="token operator">::</span><span class="token function">GpuMat</span><span class="token punctuation">(</span>InputArray arr<span class="token punctuation">,</span> GpuMat<span class="token operator">::</span>Allocator<span class="token operator">*</span> allocator <span class="token operator">=</span> <span class="token class-name">GpuMat</span><span class="token operator">::</span><span class="token function">defaultAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>We have to declare how copy works between <code>GpuMat</code>. There're 2 types of copying, one is <em>shallow copy</em> and another is <em>deep copy</em>. Examples here:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">//Shallow copy, allocate data pointer and GPU(Memory)-GPU(Memory)</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span>GpuMat dst1 <span class="token operator">=</span> dst0<span class="token punctuation">;</span>

<span class="token comment">//Deep copy, allocate memory and GPU(Memory)-GPU(Memory)</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span>GpuMat dst0<span class="token punctuation">,</span> dst1<span class="token punctuation">;</span>
dst0<span class="token punctuation">.</span><span class="token function">copyTo</span><span class="token punctuation">(</span>dst1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Deep copy, allocate memory and upload to CPU(RAM)-GPU(Memory)</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span>GpuMat dst1<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>dst1<span class="token punctuation">)</span><span class="token punctuation">;</span>
cv<span class="token operator">::</span>cuda<span class="token operator">::</span>GpuMat dst1 <span class="token operator">=</span> dst0<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>OpenCV designed <em>shallow copy</em> to only copy the <strong>header</strong> and <strong>data pointer</strong> which uses same real memory and affect each other when perform a change in one of each, only useable in same memory space. The different of <em>deep copy</em> is its <strong>temporarily copy the data</strong> with no affection of each when one is changed, not restricted to the type of the memory whether RAM or GPU Memory.</p> <p>Now we found that our main idea to use CUDA is increase the performance when processing data with the complex algorithm but not a huge amount of data in real time. Because too many data transferred instantly causes IO overflow and transferring data from RAM and GPU Memory requires amount of computing performance and increases its delay, through OpenCV developer designed <code>PtrStepSz</code> and <code>PtrStep</code> two light-weighted class in OpenCV2 to reduce copying data size for fast and low latency computing.</p> <p>I still confused about how to pass <code>VideoCapture</code> stream directly to GPU Memory, in that case we don't need to <em>upload</em> or <em>download</em> frames from GPU Memory to RAM, just grab frames from stream in <code>GpuMat</code>. Because NVIDIA Video Decoder(<em>NVCUVID</em>) is deprecated and the funtion below is no longer working.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>cv<span class="token operator">::</span>Ptr<span class="token operator">&lt;</span>cv<span class="token operator">::</span>cudacodec<span class="token operator">::</span>VideoReader<span class="token operator">&gt;</span> d_reader <span class="token operator">=</span> cv<span class="token operator">::</span>cudacodec<span class="token operator">::</span><span class="token function">createVideoReader</span><span class="token punctuation">(</span>fname<span class="token punctuation">)</span>
</code></pre></div><p>For older CUDA version 8 the <code>createVideoReader()</code> would pass camera frames directly to GPU Memory.</p> <p>Here I wrote a function that grab frame from streams and liner blend with a static image part example using OpenCV CUDA:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>Mat video_frame_temp<span class="token punctuation">,</span> temp_frame_downloaded<span class="token punctuation">;</span>
GpuMat mask_image<span class="token punctuation">,</span> video_frame<span class="token punctuation">,</span> temp_frame<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">initWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">namedWindow</span><span class="token punctuation">(</span>WINDOW_NAME<span class="token punctuation">,</span> WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">blendFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">getWindowProperty</span><span class="token punctuation">(</span>WINDOW_NAME<span class="token punctuation">,</span> WINDOW_AUTOSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>        
        <span class="token function">grabFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>video_frame_temp<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        video_frame<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>video_frame_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">blendImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">outputImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">waitKey</span><span class="token punctuation">(</span>GRAB_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">grabFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    capture <span class="token operator">&gt;&gt;</span> video_frame_temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">blendImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cv<span class="token operator">::</span>cuda<span class="token operator">::</span><span class="token function">addWeighted</span><span class="token punctuation">(</span>video_frame<span class="token punctuation">,</span> ALPHA<span class="token punctuation">,</span> mask_image<span class="token punctuation">,</span> BETA<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> temp_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">outputImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    temp_frame<span class="token punctuation">.</span><span class="token function">download</span><span class="token punctuation">(</span>temp_frame_downloaded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span>WINDOW_NAME<span class="token punctuation">,</span> temp_frame_downloaded<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>With <em>OpenGL</em> support, we could easily write using built-in function:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">namedWindow</span><span class="token punctuation">(</span>WINDOW_NAME<span class="token punctuation">,</span> WINDOW_AUTOSIZE<span class="token punctuation">)</span>
<span class="token function">namedWindow</span><span class="token punctuation">(</span>WINDOW_NAME<span class="token punctuation">,</span> WINDOW_OPENGL<span class="token punctuation">)</span>
</code></pre></div><p>Using <code>WINDOW_OPENGL</code> and then we could access <code>temp_frame</code> directly by enabling function <code>imshow</code> to directly access to <em>GPU Memory</em>. For example <code>outputImage</code> could be write like this:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">outputImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span>WINDOW_NAME<span class="token punctuation">,</span> temp_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>It saves valuable time when copying GPU Memory to RAM and makes processed image displayed faster.</p> <h2 id="color-area"><a href="#color-area" class="header-anchor">#</a> Color area</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>ubn<span class="token operator">::</span><span class="token function">colorArea</span><span class="token punctuation">(</span>ubn<span class="token operator">::</span>StreamProp stream_prop<span class="token punctuation">,</span> ubn<span class="token operator">::</span>RectProp rect_prop<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>ubn<span class="token operator">::</span>ColorRange<span class="token operator">&gt;</span> color<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> tries<span class="token punctuation">)</span>
</code></pre></div></div> <p>A basic function used for calculating the area size of specialized colors and find the color which has the biggest area size using <em>OpenCV</em>, multithreading featured.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">/* Written by Unbinilium Jan, 12, 2020 :( */</span>

<span class="token comment">//Include basic headers</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token comment">//Include opencv headers</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/core.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgproc.hpp&gt;</span></span>

<span class="token comment">//Include multithreading headers</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span></span>

<span class="token comment">//Create my own namespace</span>
<span class="token keyword">namespace</span> ubn <span class="token punctuation">{</span>
    
    <span class="token comment">//Struct video streaming prop class</span>
    <span class="token keyword">class</span> <span class="token class-name">StreamProp</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> camera_id<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> api_id<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> frame_width<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> frame_height<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> camrea_exposure_mode<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> camera_exposure<span class="token punctuation">;</span>
        <span class="token keyword">int</span> frame_threshold<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> camera_angle_V<span class="token punctuation">;</span>
        <span class="token keyword">int</span> waitkey_delay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">//Struct color area threshold prop class</span>
    <span class="token keyword">class</span> <span class="token class-name">RectProp</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">int</span> contour_depth<span class="token punctuation">;</span>
        <span class="token keyword">double</span> canny_threshold<span class="token punctuation">;</span>
        <span class="token keyword">double</span> area_threshold<span class="token punctuation">;</span>
        <span class="token keyword">double</span> cosine_max_threshold<span class="token punctuation">;</span>
        <span class="token keyword">double</span> approx_epsilon<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">//Struct color range threshold class</span>
    <span class="token keyword">class</span> <span class="token class-name">ColorRange</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">const</span> std<span class="token operator">::</span>string color_name<span class="token punctuation">;</span>
        <span class="token keyword">int</span> lowerb<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> upperb<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> threshold<span class="token punctuation">;</span>
        <span class="token keyword">int</span> color_location<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//Struct call back function for opencv trackbar</span>
    <span class="token keyword">void</span> <span class="token function">callBack</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token comment">//Calculate the distance between 2 point p1 and p2</span>
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
    <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">calPointDist</span><span class="token punctuation">(</span>T <span class="token operator">&amp;</span>p1<span class="token punctuation">,</span> T <span class="token operator">&amp;</span>p2<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>x <span class="token operator">-</span> p2<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>y <span class="token operator">-</span> p2<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> std<span class="token operator">::</span><span class="token function">sqrt</span><span class="token punctuation">(</span>a <span class="token operator">*</span> a <span class="token operator">+</span> b <span class="token operator">*</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//Calculate the intersect point between 2 line a and b</span>
    <span class="token keyword">static</span> cv<span class="token operator">::</span>Point2f <span class="token function">calIntersect</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>Vec4i <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> cv<span class="token operator">::</span>Vec4i <span class="token operator">&amp;</span>b<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token operator">::</span>Point2f pt<span class="token punctuation">;</span>
        <span class="token keyword">int</span> S<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> A <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> B <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C <span class="token operator">=</span> S<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> S<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> S<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> S<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        pt<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">(</span>A <span class="token operator">*</span> S<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> B <span class="token operator">*</span> S<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> C<span class="token punctuation">;</span>
        pt<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token punctuation">(</span>A <span class="token operator">*</span> S<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> B <span class="token operator">*</span> S<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> C<span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> pt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//Calculate the cross line's angle by 3 point pt0, pt1 and pt2</span>
    <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">calAngle</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>Point <span class="token operator">&amp;</span>pt1<span class="token punctuation">,</span> cv<span class="token operator">::</span>Point <span class="token operator">&amp;</span>pt2<span class="token punctuation">,</span> cv<span class="token operator">::</span>Point <span class="token operator">&amp;</span>pt0<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">double</span> dx1 <span class="token operator">=</span> pt1<span class="token punctuation">.</span>x <span class="token operator">-</span> pt0<span class="token punctuation">.</span>x<span class="token punctuation">,</span> dy1 <span class="token operator">=</span> pt1<span class="token punctuation">.</span>y <span class="token operator">-</span> pt0<span class="token punctuation">.</span>y<span class="token punctuation">,</span> dx2 <span class="token operator">=</span> pt2<span class="token punctuation">.</span>x <span class="token operator">-</span> pt0<span class="token punctuation">.</span>x<span class="token punctuation">,</span> dy2 <span class="token operator">=</span> pt2<span class="token punctuation">.</span>y <span class="token operator">-</span> pt0<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token punctuation">(</span>dx1 <span class="token operator">*</span> dx2 <span class="token operator">+</span> dy1 <span class="token operator">*</span> dy2<span class="token punctuation">)</span> <span class="token operator">/</span> std<span class="token operator">::</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dx1 <span class="token operator">*</span> dx1 <span class="token operator">+</span> dy1 <span class="token operator">*</span> dy1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>dx2 <span class="token operator">*</span> dx2 <span class="token operator">+</span> dy2 <span class="token operator">*</span> dy2<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1e-10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//Find the maxium rectangle as recognition screen</span>
    <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">findRects</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>Mat <span class="token operator">&amp;</span>input_image<span class="token punctuation">,</span> cv<span class="token operator">::</span>Mat <span class="token operator">&amp;</span>output_image<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Point<span class="token operator">&gt;&gt;</span> <span class="token operator">&amp;</span>rects<span class="token punctuation">,</span> ubn<span class="token operator">::</span>RectProp <span class="token operator">&amp;</span>rect_prop<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token operator">::</span>Mat input_image_pyr<span class="token punctuation">,</span> input_image_tmp<span class="token punctuation">,</span> input_image_gray<span class="token punctuation">,</span> <span class="token function">input_image_gray_tmp</span><span class="token punctuation">(</span>input_image<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CV_8U<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//Scale the image to 1/2 and restore it's original size to denoise</span>
        cv<span class="token operator">::</span><span class="token function">pyrDown</span><span class="token punctuation">(</span>input_image<span class="token punctuation">,</span> input_image_pyr<span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Size</span><span class="token punctuation">(</span>input_image<span class="token punctuation">.</span>cols <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> input_image<span class="token punctuation">.</span>rows <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cv<span class="token operator">::</span><span class="token function">pyrUp</span><span class="token punctuation">(</span>input_image_pyr<span class="token punctuation">,</span> input_image_tmp<span class="token punctuation">,</span> input_image<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Point<span class="token operator">&gt;&gt;</span> contours<span class="token punctuation">;</span>
        
        <span class="token comment">//Do something on each channel of input image</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">int</span> ch<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            
            <span class="token comment">//Separate hue channel from input image</span>
            cv<span class="token operator">::</span><span class="token function">mixChannels</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input_image_tmp<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_image_gray_tmp<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//Extract contours, loop serval times</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">!=</span> rect_prop<span class="token punctuation">.</span>contour_depth<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                
                <span class="token comment">//Canny and dilate for the first time, threshold from the second time</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>j <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    cv<span class="token operator">::</span><span class="token function">Canny</span><span class="token punctuation">(</span>input_image_gray_tmp<span class="token punctuation">,</span> input_image_gray<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> rect_prop<span class="token punctuation">.</span>canny_threshold<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cv<span class="token operator">::</span><span class="token function">dilate</span><span class="token punctuation">(</span>input_image_gray<span class="token punctuation">,</span> input_image_gray<span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Point</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    input_image_gray <span class="token operator">=</span> input_image_gray_tmp <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255</span> <span class="token operator">/</span> rect_prop<span class="token punctuation">.</span>contour_depth<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                <span class="token comment">//Find contours</span>
                cv<span class="token operator">::</span><span class="token function">findContours</span><span class="token punctuation">(</span>input_image_gray<span class="token punctuation">,</span> contours<span class="token punctuation">,</span> cv<span class="token operator">::</span>RETR_LIST<span class="token punctuation">,</span> cv<span class="token operator">::</span>CHAIN_APPROX_SIMPLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Point<span class="token operator">&gt;</span> approx<span class="token punctuation">;</span>
                
                <span class="token comment">//For each contour in contours</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> _contours <span class="token operator">:</span> contours<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>  
                    <span class="token comment">//Approximates a polygonal curve with the specified precision</span>
                    cv<span class="token operator">::</span><span class="token function">approxPolyDP</span><span class="token punctuation">(</span>_contours<span class="token punctuation">,</span> approx<span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">arcLength</span><span class="token punctuation">(</span>_contours<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">*</span> rect_prop<span class="token punctuation">.</span>approx_epsilon<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                    <span class="token comment">//Test contour convexity and if contour area is larger than threshold</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>approx<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> std<span class="token operator">::</span><span class="token function">fabs</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">contourArea</span><span class="token punctuation">(</span>approx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> rect_prop<span class="token punctuation">.</span>area_threshold <span class="token operator">&amp;&amp;</span> cv<span class="token operator">::</span><span class="token function">isContourConvex</span><span class="token punctuation">(</span>approx<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token keyword">double</span> cosine_max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        
                        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> l <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> l <span class="token operator">!=</span> <span class="token number">5</span><span class="token punctuation">;</span> l<span class="token operator">++</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            <span class="token keyword">double</span> cosine <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">fabs</span><span class="token punctuation">(</span>ubn<span class="token operator">::</span><span class="token function">calAngle</span><span class="token punctuation">(</span>approx<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>l <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> approx<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>l <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> approx<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            
                            cosine_max <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>cosine_max<span class="token punctuation">,</span> cosine<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        
                        <span class="token comment">//Select the rects which each corner angle cosine is less than 0.3</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>cosine_max <span class="token operator">&lt;</span> <span class="token number">0.3</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            rects<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>approx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                
                contours<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                approx<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//No rectangles find</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>rects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> area_max_tag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> area_cur_tmp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> area_max_tmp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        
        <span class="token comment">//Find the maxium rectangle contour</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> rects<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            area_cur_tmp <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">contourArea</span><span class="token punctuation">(</span>rects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span>area_cur_tmp <span class="token operator">&gt;</span> area_max_tmp<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                area_max_tmp <span class="token operator">=</span> area_cur_tmp<span class="token punctuation">;</span>
                area_max_tag <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Vec4i<span class="token operator">&gt;</span> edges<span class="token punctuation">;</span>
        
        <span class="token comment">//Inspect 4 edges form maxium rectangle contour</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> rects<span class="token punctuation">[</span>area_max_tag<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            cv<span class="token operator">::</span>Point p1 <span class="token operator">=</span> rects<span class="token punctuation">[</span>area_max_tag<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            cv<span class="token operator">::</span>Point p2 <span class="token operator">=</span> rects<span class="token punctuation">[</span>area_max_tag<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> rects<span class="token punctuation">[</span>area_max_tag<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span>ubn<span class="token operator">::</span><span class="token function">calPointDist</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">*</span> cv<span class="token operator">::</span><span class="token function">arcLength</span><span class="token punctuation">(</span>rects<span class="token punctuation">[</span>area_max_tag<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">*</span> rect_prop<span class="token punctuation">.</span>approx_epsilon<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                edges<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">Vec4i</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p1<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p2<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p2<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Point<span class="token operator">&gt;</span> corners<span class="token punctuation">;</span>
        
        <span class="token comment">//Inspect 4 corner form maxium rectangle contour</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> edges<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            cv<span class="token operator">::</span>Point cornor <span class="token operator">=</span> ubn<span class="token operator">::</span><span class="token function">calIntersect</span><span class="token punctuation">(</span>edges<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> edges<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> edges<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            corners<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cornor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        edges<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//Transform cornor data type</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Point2f<span class="token operator">&gt;</span> corners2f<span class="token punctuation">;</span>
        std<span class="token operator">::</span><span class="token function">transform</span><span class="token punctuation">(</span>corners<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> corners<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">back_inserter</span><span class="token punctuation">(</span>corners2f<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token operator">::</span>Point <span class="token operator">&amp;</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> cv<span class="token operator">::</span><span class="token function">Point2f</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        corners<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//Sort cornor by point location</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>corners2f<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">unsigned</span> <span class="token keyword">int</span> corner_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            cv<span class="token operator">::</span>Point2f corner_tmp <span class="token operator">=</span> corners2f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            
            <span class="token comment">//Sort cornor from left to right</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> corners2f<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>corner_tmp<span class="token punctuation">.</span>x <span class="token operator">&gt;</span> corners2f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    corner_tmp <span class="token operator">=</span> corners2f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    corner_index <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            
            corners2f<span class="token punctuation">[</span>corner_index<span class="token punctuation">]</span> <span class="token operator">=</span> corners2f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            corners2f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> corner_tmp<span class="token punctuation">;</span>
            
            <span class="token comment">//Sort cornor from up to down</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> corners2f<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">!=</span> corners2f<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>corners2f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">-</span> corners2f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>corners2f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> corners2f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span>corners2f<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">-</span> corners2f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>corners2f<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> corners2f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        cv<span class="token operator">::</span>Point2f tmp <span class="token operator">=</span> corners2f<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        corners2f<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> corners2f<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        corners2f<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//Calculate perspective anchor</span>
        cv<span class="token operator">::</span>Point2f anchor<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> corners2f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>corners2f<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>corners2f<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>corners2f<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> anchor_dist<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> ubn<span class="token operator">::</span><span class="token function">calPointDist</span><span class="token punctuation">(</span>anchor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> anchor<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ubn<span class="token operator">::</span><span class="token function">calPointDist</span><span class="token punctuation">(</span>anchor<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> anchor<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ubn<span class="token operator">::</span><span class="token function">calPointDist</span><span class="token punctuation">(</span>anchor<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> anchor<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ubn<span class="token operator">::</span><span class="token function">calPointDist</span><span class="token punctuation">(</span>anchor<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> anchor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> width <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token function">MAX</span><span class="token punctuation">(</span>anchor_dist<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> anchor_dist<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> height <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token function">MAX</span><span class="token punctuation">(</span>anchor_dist<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> anchor_dist<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        input_image_tmp <span class="token operator">=</span> input_image<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output_image <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token class-name">Mat</span><span class="token operator">::</span><span class="token function">zeros</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> width<span class="token punctuation">,</span> CV_8UC3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Point2f<span class="token operator">&gt;</span> output_image_anchor<span class="token punctuation">;</span>
        
        output_image_anchor<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">Point2f</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> output_image<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output_image_anchor<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">Point2f</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output_image_anchor<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">Point2f</span><span class="token punctuation">(</span>output_image<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output_image_anchor<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">Point2f</span><span class="token punctuation">(</span>output_image<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> output_image<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//Applies the perspective transformation to input image</span>
        cv<span class="token operator">::</span><span class="token function">warpPerspective</span><span class="token punctuation">(</span>input_image_tmp<span class="token punctuation">,</span> output_image<span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">getPerspectiveTransform</span><span class="token punctuation">(</span>corners2f <span class="token punctuation">,</span> output_image_anchor<span class="token punctuation">)</span><span class="token punctuation">,</span> output_image<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        corners2f<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output_image_anchor<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//Struct color area class</span>
    <span class="token keyword">class</span> <span class="token class-name">ColorArea</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">double</span> area_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        
        <span class="token comment">//Threshold image in color range</span>
        <span class="token keyword">void</span> <span class="token function">inRangeColorArea</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>Mat input_img<span class="token punctuation">,</span> ubn<span class="token operator">::</span>ColorRange input_color<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//Display image</span>
        <span class="token keyword">void</span> <span class="token function">inRangeColorView</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string window_name<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            cv<span class="token operator">::</span><span class="token function">imshow</span><span class="token punctuation">(</span>window_name<span class="token punctuation">,</span> input_img_tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token keyword">private</span><span class="token operator">:</span>
        cv<span class="token operator">::</span>Mat input_img_tmp<span class="token punctuation">;</span>
        cv<span class="token operator">::</span>Scalar input_lowerb_tmp<span class="token punctuation">;</span>
        cv<span class="token operator">::</span>Scalar input_upperb_tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">class</span> <span class="token class-name">FrameHelper</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>sem_t <span class="token operator">*</span><span class="token operator">&gt;</span> sem<span class="token punctuation">;</span>
        cv<span class="token operator">::</span>Mat <span class="token operator">*</span>frame<span class="token punctuation">;</span>
        ubn<span class="token operator">::</span>StreamProp <span class="token operator">*</span>stream_prop<span class="token punctuation">;</span>
        ubn<span class="token operator">::</span>RectProp <span class="token operator">*</span>rect_prop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">ColorAreaHelper</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        sem_t <span class="token operator">*</span>sem<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        cv<span class="token operator">::</span>Mat <span class="token operator">*</span>frame<span class="token punctuation">;</span>
        ubn<span class="token operator">::</span>ColorArea <span class="token operator">*</span>color_area<span class="token punctuation">;</span>
        ubn<span class="token operator">::</span>ColorRange <span class="token operator">*</span>input_color<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">SortHelper</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>sem_t <span class="token operator">*</span><span class="token operator">&gt;</span> sem<span class="token punctuation">;</span>
        ubn<span class="token operator">::</span>StreamProp <span class="token operator">*</span>stream_prop<span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>ubn<span class="token operator">::</span>ColorArea <span class="token operator">*</span><span class="token operator">&gt;</span> color_area<span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>ubn<span class="token operator">::</span>ColorRange <span class="token operator">*</span><span class="token operator">&gt;</span> input_color<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>color_variety<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>tries<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>color_area_freq_max_tag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">//Calculate the area of one color</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">areaOfColor</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>Mat <span class="token operator">*</span>p_input_img<span class="token punctuation">,</span> cv<span class="token operator">::</span>Scalar <span class="token operator">*</span>p_input_lowerb<span class="token punctuation">,</span> cv<span class="token operator">::</span>Scalar <span class="token operator">*</span>p_input_upperb<span class="token punctuation">,</span> <span class="token keyword">double</span> <span class="token operator">*</span>p_area_sum<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>p_threshold<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token operator">*</span>p_area_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> area_tmp<span class="token punctuation">;</span>
        
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Point<span class="token operator">&gt;&gt;</span> contours<span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Vec4i<span class="token operator">&gt;</span> hierarchy<span class="token punctuation">;</span>
        
        <span class="token comment">//Find contours</span>
        cv<span class="token operator">::</span><span class="token function">inRange</span><span class="token punctuation">(</span><span class="token operator">*</span>p_input_img<span class="token punctuation">,</span> <span class="token operator">*</span>p_input_lowerb<span class="token punctuation">,</span> <span class="token operator">*</span>p_input_upperb<span class="token punctuation">,</span> <span class="token operator">*</span>p_input_img<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cv<span class="token operator">::</span><span class="token function">findContours</span><span class="token punctuation">(</span><span class="token operator">*</span>p_input_img<span class="token punctuation">,</span> contours<span class="token punctuation">,</span> hierarchy<span class="token punctuation">,</span> cv<span class="token operator">::</span>RETR_EXTERNAL<span class="token punctuation">,</span> cv<span class="token operator">::</span>CHAIN_APPROX_SIMPLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//Sum the area of all founded contours</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> _contours <span class="token operator">:</span> contours<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            area_tmp <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">contourArea</span><span class="token punctuation">(</span>_contours<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>area_tmp <span class="token operator">&gt;</span> <span class="token operator">*</span>p_threshold<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token operator">*</span>p_area_sum <span class="token operator">+=</span> area_tmp<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        contours<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hierarchy<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//Clone image in ColorArea, pass to areaOfColor function</span>
    <span class="token keyword">void</span> <span class="token class-name">ColorArea</span><span class="token operator">::</span><span class="token function">inRangeColorArea</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>Mat input_img<span class="token punctuation">,</span> ubn<span class="token operator">::</span>ColorRange input_color<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        input_img_tmp <span class="token operator">=</span> input_img<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        input_lowerb_tmp <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span>input_color<span class="token punctuation">.</span>lowerb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_color<span class="token punctuation">.</span>lowerb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_color<span class="token punctuation">.</span>lowerb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        input_upperb_tmp <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span>input_color<span class="token punctuation">.</span>upperb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_color<span class="token punctuation">.</span>upperb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_color<span class="token punctuation">.</span>upperb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//Pass cloned image and HSV threshold to calculate color area</span>
        <span class="token function">areaOfColor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input_img_tmp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_lowerb_tmp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_upperb_tmp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>area_sum<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_color<span class="token punctuation">.</span>threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//Read frame from camera and find the display</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">frameHelper</span><span class="token punctuation">(</span>ubn<span class="token operator">::</span>FrameHelper <span class="token operator">*</span>helper<span class="token punctuation">)</span>
    <span class="token punctuation">{</span> 
        <span class="token comment">//Open camera</span>
        cv<span class="token operator">::</span>VideoCapture capture<span class="token punctuation">;</span>
        capture<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>camera_id <span class="token operator">+</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>api_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>capture<span class="token punctuation">.</span><span class="token function">isOpened</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;colorArea: capture not opened&quot;</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
            
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        capture<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>CAP_PROP_FRAME_WIDTH<span class="token punctuation">,</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_width<span class="token punctuation">)</span><span class="token punctuation">;</span>
        capture<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>CAP_PROP_FRAME_HEIGHT<span class="token punctuation">,</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        capture<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>CAP_PROP_AUTO_EXPOSURE<span class="token punctuation">,</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>camrea_exposure_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        capture<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cv<span class="token operator">::</span>CAP_PROP_EXPOSURE<span class="token punctuation">,</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>camera_exposure<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;colorArea: capture set-&gt;&quot;</span> <span class="token operator">&lt;&lt;</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>camera_id <span class="token operator">+</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>api_id <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;-&gt;&quot;</span> <span class="token operator">&lt;&lt;</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_width <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">&lt;&lt;</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_height <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        
        cv<span class="token operator">::</span>Mat frame<span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Point<span class="token operator">&gt;&gt;</span> rects<span class="token punctuation">;</span>
        
        <span class="token comment">//Grab frames from camera</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            capture<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//Avoid empty frame</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">//Crop frame</span>
            frame <span class="token operator">=</span> <span class="token function">frame</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">Range</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_threshold<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_threshold<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Range</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_threshold<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_threshold<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//Display frame</span>
            cv<span class="token operator">::</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">&quot;frame&quot;</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cv<span class="token operator">::</span><span class="token function">waitKey</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>waitkey_delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//Find maxium rect display in frame</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ubn<span class="token operator">::</span><span class="token function">findRects</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> rects<span class="token punctuation">,</span> <span class="token operator">*</span>helper<span class="token operator">-&gt;</span>rect_prop<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            rects<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//Convert frame color from HSV to BGR</span>
            cv<span class="token operator">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> cv<span class="token operator">::</span>COLOR_HSV2BGR_FULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//Decrease singal sem[0]</span>
            <span class="token function">sem_wait</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>sem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//Copy frame data to *helper-&gt;frame</span>
            frame<span class="token punctuation">.</span><span class="token function">copyTo</span><span class="token punctuation">(</span><span class="token operator">*</span>helper<span class="token operator">-&gt;</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//Increase the singal for colorAreaHelper threads</span>
            <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> loop <span class="token operator">=</span> <span class="token function">u_int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>sem<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> loop<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">sem_post</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>sem<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//Calculate area size for each colors</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span>noreturn<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">colorAreaHelper</span><span class="token punctuation">(</span>ubn<span class="token operator">::</span>ColorAreaHelper <span class="token operator">*</span>helper<span class="token punctuation">)</span>
    <span class="token punctuation">{</span> 
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//Wait singal sem[0]</span>
            <span class="token function">sem_wait</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>sem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//Calculate area size for one color</span>
            helper<span class="token operator">-&gt;</span>color_area<span class="token operator">-&gt;</span><span class="token function">inRangeColorArea</span><span class="token punctuation">(</span><span class="token operator">*</span>helper<span class="token operator">-&gt;</span>frame<span class="token punctuation">,</span> <span class="token operator">*</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//Increase singal sem[1]</span>
            <span class="token function">sem_post</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>sem<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    

    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sortHelper</span><span class="token punctuation">(</span>ubn<span class="token operator">::</span>SortHelper <span class="token operator">*</span>helper<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> tries <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token operator">*</span>helper<span class="token operator">-&gt;</span>tries<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> color_area_max_tag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">color_area_freq</span><span class="token punctuation">(</span><span class="token operator">*</span>helper<span class="token operator">-&gt;</span>color_variety<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">int</span> cur_color <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> cur_color_tag <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>color_variety <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        std<span class="token operator">::</span>string cur_name<span class="token punctuation">;</span>
        std<span class="token operator">::</span>string cur_slider_name<span class="token punctuation">;</span>
        
        <span class="token comment">//Display color and HSV threshold slider window</span>
        cv<span class="token operator">::</span><span class="token function">namedWindow</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>color_name<span class="token punctuation">,</span> cv<span class="token operator">::</span>WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cv<span class="token operator">::</span><span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>color_name <span class="token operator">+</span> <span class="token string">&quot; slider&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token operator">::</span>WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//Sort all areas</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> tries<span class="token operator">--</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//Wait colorAreaHelper threads finish</span>
            <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> loop <span class="token operator">=</span> <span class="token operator">*</span>helper<span class="token operator">-&gt;</span>color_variety <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> loop<span class="token punctuation">;</span> i <span class="token operator">!=</span> helper<span class="token operator">-&gt;</span>sem<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">sem_wait</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>sem<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">//Increase signal sem[0]</span>
            <span class="token function">sem_post</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>sem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">double</span> color_area_max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            
            <span class="token comment">//Find the maxium color area's color index</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> <span class="token operator">*</span>helper<span class="token operator">-&gt;</span>color_variety<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>color_area<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>area_sum <span class="token operator">&gt;</span> color_area_max<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    color_area_max <span class="token operator">=</span> helper<span class="token operator">-&gt;</span>color_area<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>area_sum<span class="token punctuation">;</span>
                    color_area_max_tag <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">//Increase color_area_freq for maxium color area's color index</span>
            color_area_freq<span class="token punctuation">[</span>color_area_max_tag<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
            
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;colorArea: &quot;</span> <span class="token operator">&lt;&lt;</span> helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span>color_area_max_tag<span class="token punctuation">]</span><span class="token operator">-&gt;</span>color_name <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;-&gt;&quot;</span> <span class="token operator">&lt;&lt;</span> color_area_freq<span class="token punctuation">[</span>color_area_max_tag<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">&lt;&lt;</span> color_area_max <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
            
            <span class="token comment">//Create and refreash sliderbar if current color window is changed</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>cur_color_tag <span class="token operator">!=</span> cur_color<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                cur_name <span class="token operator">=</span> helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>color_name<span class="token punctuation">;</span>
                cur_slider_name <span class="token operator">=</span> cur_name <span class="token operator">+</span> <span class="token string">&quot; slider&quot;</span><span class="token punctuation">;</span>
                
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">getWindowProperty</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color_tag<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>color_name<span class="token punctuation">,</span> cv<span class="token operator">::</span>WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    cv<span class="token operator">::</span><span class="token function">destroyWindow</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color_tag<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>color_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cv<span class="token operator">::</span><span class="token function">namedWindow</span><span class="token punctuation">(</span>cur_name<span class="token punctuation">,</span> cv<span class="token operator">::</span>WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">getWindowProperty</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color_tag<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>color_name <span class="token operator">+</span> <span class="token string">&quot; slider&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token operator">::</span>WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    cv<span class="token operator">::</span><span class="token function">destroyWindow</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color_tag<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>color_name <span class="token operator">+</span> <span class="token string">&quot; slider&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cv<span class="token operator">::</span><span class="token function">namedWindow</span><span class="token punctuation">(</span>cur_slider_name<span class="token punctuation">,</span> cv<span class="token operator">::</span>WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                cv<span class="token operator">::</span><span class="token function">createTrackbar</span><span class="token punctuation">(</span><span class="token string">&quot;Color&quot;</span><span class="token punctuation">,</span> cur_slider_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cur_color<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token operator">*</span>helper<span class="token operator">-&gt;</span>color_variety <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ubn<span class="token operator">::</span>callBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token operator">::</span><span class="token function">createTrackbar</span><span class="token punctuation">(</span><span class="token string">&quot;T_Area&quot;</span><span class="token punctuation">,</span> cur_slider_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>threshold<span class="token punctuation">,</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_width <span class="token operator">*</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_height<span class="token punctuation">,</span> ubn<span class="token operator">::</span>callBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token operator">::</span><span class="token function">createTrackbar</span><span class="token punctuation">(</span><span class="token string">&quot;T_x_s&quot;</span><span class="token punctuation">,</span> cur_slider_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_threshold<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_width<span class="token punctuation">,</span> ubn<span class="token operator">::</span>callBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token operator">::</span><span class="token function">createTrackbar</span><span class="token punctuation">(</span><span class="token string">&quot;T_x_e&quot;</span><span class="token punctuation">,</span> cur_slider_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_threshold<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_width<span class="token punctuation">,</span> ubn<span class="token operator">::</span>callBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token operator">::</span><span class="token function">createTrackbar</span><span class="token punctuation">(</span><span class="token string">&quot;T_y_s&quot;</span><span class="token punctuation">,</span> cur_slider_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_threshold<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_height<span class="token punctuation">,</span> ubn<span class="token operator">::</span>callBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token operator">::</span><span class="token function">createTrackbar</span><span class="token punctuation">(</span><span class="token string">&quot;T_y_e&quot;</span><span class="token punctuation">,</span> cur_slider_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_threshold<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>frame_height<span class="token punctuation">,</span> ubn<span class="token operator">::</span>callBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token operator">::</span><span class="token function">createTrackbar</span><span class="token punctuation">(</span><span class="token string">&quot;H_L&quot;</span><span class="token punctuation">,</span> cur_slider_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>lowerb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">360</span><span class="token punctuation">,</span> ubn<span class="token operator">::</span>callBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token operator">::</span><span class="token function">createTrackbar</span><span class="token punctuation">(</span><span class="token string">&quot;H_U&quot;</span><span class="token punctuation">,</span> cur_slider_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>upperb<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">360</span><span class="token punctuation">,</span> ubn<span class="token operator">::</span>callBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token operator">::</span><span class="token function">createTrackbar</span><span class="token punctuation">(</span><span class="token string">&quot;S_L&quot;</span><span class="token punctuation">,</span> cur_slider_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>lowerb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> ubn<span class="token operator">::</span>callBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token operator">::</span><span class="token function">createTrackbar</span><span class="token punctuation">(</span><span class="token string">&quot;S_U&quot;</span><span class="token punctuation">,</span> cur_slider_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>upperb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> ubn<span class="token operator">::</span>callBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token operator">::</span><span class="token function">createTrackbar</span><span class="token punctuation">(</span><span class="token string">&quot;V_L&quot;</span><span class="token punctuation">,</span> cur_slider_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>lowerb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> ubn<span class="token operator">::</span>callBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cv<span class="token operator">::</span><span class="token function">createTrackbar</span><span class="token punctuation">(</span><span class="token string">&quot;V_U&quot;</span><span class="token punctuation">,</span> cur_slider_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>upperb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> ubn<span class="token operator">::</span>callBack<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            cur_color_tag <span class="token operator">=</span> cur_color<span class="token punctuation">;</span>
            
            helper<span class="token operator">-&gt;</span>color_area<span class="token punctuation">[</span><span class="token function">uint</span><span class="token punctuation">(</span>cur_color<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">inRangeColorView</span><span class="token punctuation">(</span>cur_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cv<span class="token operator">::</span><span class="token function">waitKey</span><span class="token punctuation">(</span>helper<span class="token operator">-&gt;</span>stream_prop<span class="token operator">-&gt;</span>waitkey_delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token punctuation">}</span>
        
        <span class="token comment">//Find the maxium color_area_freq and set as color_area_freq_max_tag</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> color_area_freq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>color_area_freq<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> color_area_freq<span class="token punctuation">[</span><span class="token operator">*</span>helper<span class="token operator">-&gt;</span>color_area_freq_max_tag<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token operator">*</span>helper<span class="token operator">-&gt;</span>color_area_freq_max_tag <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;colorArea: &quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;maxarea&quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;-&gt;&quot;</span> <span class="token operator">&lt;&lt;</span> helper<span class="token operator">-&gt;</span>input_color<span class="token punctuation">[</span><span class="token operator">*</span>helper<span class="token operator">-&gt;</span>color_area_freq_max_tag<span class="token punctuation">]</span><span class="token operator">-&gt;</span>color_name <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">&lt;&lt;</span> color_area_freq<span class="token punctuation">[</span><span class="token operator">*</span>helper<span class="token operator">-&gt;</span>color_area_freq_max_tag<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;colorArea: ended-&gt;&quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>helper<span class="token operator">-&gt;</span>tries <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        
        color_area_freq<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        cv<span class="token operator">::</span><span class="token function">destroyAllWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">colorArea</span><span class="token punctuation">(</span>ubn<span class="token operator">::</span>StreamProp stream_prop<span class="token punctuation">,</span> ubn<span class="token operator">::</span>RectProp rect_prop<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>ubn<span class="token operator">::</span>ColorRange<span class="token operator">&gt;</span> color<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> tries<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token operator">::</span>Mat frame<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> color_area_freq_max_tag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> color_variety <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>thread<span class="token operator">&gt;</span> threads<span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>sem_t<span class="token operator">&gt;</span> <span class="token function">sem</span><span class="token punctuation">(</span>color_variety <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//Create frameHelper thread</span>
        ubn<span class="token operator">::</span>FrameHelper frame_helper<span class="token punctuation">;</span>
        frame_helper<span class="token punctuation">.</span>frame <span class="token operator">=</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> _sem <span class="token operator">:</span> sem<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            frame_helper<span class="token punctuation">.</span>sem<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        frame_helper<span class="token punctuation">.</span>stream_prop <span class="token operator">=</span> <span class="token operator">&amp;</span>stream_prop<span class="token punctuation">;</span>
        frame_helper<span class="token punctuation">.</span>rect_prop <span class="token operator">=</span> <span class="token operator">&amp;</span>rect_prop<span class="token punctuation">;</span>
        threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">thread</span><span class="token punctuation">(</span>ubn<span class="token operator">::</span>frameHelper<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame_helper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//Create colorArea thread</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>ubn<span class="token operator">::</span>ColorArea<span class="token operator">&gt;</span> <span class="token function">color_area</span><span class="token punctuation">(</span>color_variety<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>ubn<span class="token operator">::</span>ColorAreaHelper<span class="token operator">&gt;</span> <span class="token function">color_area_helper</span><span class="token punctuation">(</span>color_variety<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> color_variety<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            color_area_helper<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>frame <span class="token operator">=</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">;</span>
            color_area_helper<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>sem<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            color_area_helper<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sem<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>sem<span class="token punctuation">[</span>i <span class="token operator">+</span> color_variety <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            color_area_helper<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>color_area <span class="token operator">=</span> <span class="token operator">&amp;</span>color_area<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            color_area_helper<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>input_color <span class="token operator">=</span> <span class="token operator">&amp;</span>color<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">thread</span><span class="token punctuation">(</span>ubn<span class="token operator">::</span>colorAreaHelper<span class="token punctuation">,</span> <span class="token operator">&amp;</span>color_area_helper<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//Create sortHelper thread</span>
        ubn<span class="token operator">::</span>SortHelper sort_helper<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> _sem <span class="token operator">:</span> sem<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            sort_helper<span class="token punctuation">.</span>sem<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sort_helper<span class="token punctuation">.</span>stream_prop <span class="token operator">=</span> <span class="token operator">&amp;</span>stream_prop<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> color_variety<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            sort_helper<span class="token punctuation">.</span>color_area<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>color_area<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sort_helper<span class="token punctuation">.</span>input_color<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>color<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sort_helper<span class="token punctuation">.</span>color_variety <span class="token operator">=</span> <span class="token operator">&amp;</span>color_variety<span class="token punctuation">;</span>
        sort_helper<span class="token punctuation">.</span>tries <span class="token operator">=</span> <span class="token operator">&amp;</span>tries<span class="token punctuation">;</span>
        sort_helper<span class="token punctuation">.</span>color_area_freq_max_tag <span class="token operator">=</span> <span class="token operator">&amp;</span>color_area_freq_max_tag<span class="token punctuation">;</span>
        threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">thread</span><span class="token punctuation">(</span>ubn<span class="token operator">::</span>sortHelper<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sort_helper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        threads<span class="token punctuation">[</span>threads<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> threads<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> _sem <span class="token operator">:</span> sem<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">sem_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        threads<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sem<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        color_area<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        color_area_helper<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> color_area_freq_max_tag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">CC BY-SA 4.0 / Last Updated:</span> <span class="time">1/28/2021, 9:54:53 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/programming/algorithm/" class="prev">
        Algorithm
      </a></span> <span class="next"><a href="/programming/machine-learning/">
        Machine Learning
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.041ccf91.js" defer></script><script src="/assets/js/2.30d40f56.js" defer></script><script src="/assets/js/23.db0b25e6.js" defer></script><script src="/assets/js/3.9032db0e.js" defer></script>
  </body>
</html>
